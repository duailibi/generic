<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador ALE-RR | Regimento Interno 2025</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          zIndex: { '60': '60', '70': '70', '80': '80', '100': '100' }
        }
      }
    }
  </script>

  <!-- Chart.js (apenas para gráficos 2D) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Plotly.js - Biblioteca para gráficos 3D mais estável -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; overflow: hidden; display: flex; flex-direction: column; }
    
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }

    .option-card { transition: all 0.2s ease; border-width: 2px; }
    .option-card:hover:not(.disabled) { transform: translateX(4px); }
    .light .option-card { border-color: #e2e8f0; background-color: white; }
    .light .option-card:hover:not(.disabled) { border-color: #94a3b8; background-color: #f8fafc; }
    .dark .option-card { border-color: #334155; background-color: #1e293b; color: #e2e8f0; }
    .dark .option-card:hover:not(.disabled) { border-color: #64748b; background-color: #334155; }
    .option-card.selected { border-color: #f59e0b !important; background-color: #fffbeb !important; }
    .dark .option-card.selected { background-color: #451a03 !important; border-color: #f59e0b !important; }
    .option-card.correct { border-color: #10b981 !important; background-color: #ecfdf5 !important; }
    .dark .option-card.correct { background-color: #064e3b !important; border-color: #10b981 !important; }
    .option-card.wrong { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    .dark .option-card.wrong { background-color: #450a0a !important; border-color: #ef4444 !important; }

    #pdf-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .drawer-open { transform: translateX(0) !important; }
    .drawer-closed { transform: translateX(100%); }
    
    .pdf-tab {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: translateY(-50%);
        box-shadow: -4px 0 10px rgba(0,0,0,0.1);
    }

    .locked-checkbox { opacity: 0.5; pointer-events: none; background-color: #e2e8f0; }
    .dark .locked-checkbox { background-color: #334155; }

    @media (max-width: 768px) {
      .mobile-stack { flex-direction: column; }
      .mobile-full { width: 100%; }
      .mobile-padding { padding: 1rem; }
      .mobile-text-sm { font-size: 0.875rem; }
    }

    .focus-visible:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chart-container {
      position: relative;
      height: 200px;
      width: 200px;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    /* Estilos específicos para gráficos 3D com Plotly */
    .plotly-3d-container {
      height: 500px;
      width: 100%;
      position: relative;
      background-color: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
    }
    .dark .plotly-3d-container {
      background-color: #1e293b;
    }
    
    .plotly-error {
      display: none;
      padding: 2rem;
      text-align: center;
      color: #dc2626;
    }

    .chart-controls {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dark .chart-controls {
      background: rgba(30, 41, 59, 0.9);
    }

    /* Estilos para as tabelas roláveis */
    .metrics-table-container {
      max-height: 500px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .dark .metrics-table-container {
      border-color: #475569;
    }

    .evolution-line {
      stroke: #3b82f6;
      stroke-width: 2;
      fill: none;
      stroke-dasharray: 5, 5;
    }
    .dark .evolution-line {
      stroke: #60a5fa;
    }

    .metric-card {
      transition: all 0.2s ease;
      border-left: 4px solid #3b82f6;
    }
    .dark .metric-card {
      border-left-color: #60a5fa;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Novos estilos para indicadores de evolução */
    .evolution-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 4px;
    }
    
    .evolution-positive {
      background-color: #10b98120;
      color: #10b981;
      border: 1px solid #10b98140;
    }
    
    .evolution-negative {
      background-color: #ef444420;
      color: #ef4444;
      border: 1px solid #ef444440;
    }
    
    .evolution-neutral {
      background-color: #6b728020;
      color: #6b7280;
      border: 1px solid #6b728040;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

  <nav class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 h-16 shrink-0 z-50">
    <div class="container mx-auto px-4 h-full flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer group" onclick="showScreen('home')">
        <div class="bg-brand-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30 group-hover:scale-110 transition">
          <i class="fas fa-gavel"></i>
        </div>
        <div class="leading-tight">
          <h1 class="text-xl font-bold text-slate-800 dark:text-white">ALE-RR <span class="text-brand-600 dark:text-brand-500">Simulador</span></h1>
          <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">Regimento 2023</p>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
        <button onclick="showScreen('home')" class="hidden md:flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 px-3 py-2 rounded-lg hover:bg-brand-50 dark:hover:bg-brand-900/20 transition border border-transparent hover:border-brand-200">
          <i class="fas fa-home text-brand-500"></i> <span>Início</span>
        </button>

        <div class="h-6 w-px bg-slate-200 dark:bg-slate-600 hidden md:block"></div>

        <button onclick="toggleCacheModal()" class="text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 p-2 transition" title="Gerenciar Dados">
            <i class="fas fa-database"></i>
        </button>

        <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition flex items-center justify-center">
          <i id="theme-icon" class="fas fa-moon"></i>
        </button>

        <button onclick="showScreen('analytics')" class="text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 p-2 transition" title="Histórico">
          <i class="fas fa-chart-bar"></i>
        </button>
      </div>
    </div>
  </nav>

  <div class="flex-grow relative flex overflow-hidden">
    
    <main class="flex-grow overflow-y-auto custom-scrollbar p-4 md:p-8 relative z-10 w-full" id="main-scroll-area">
        
        <div id="screen-error" class="hidden flex flex-col items-center justify-center min-h-[60vh] text-center fade-in">
            <div class="w-24 h-24 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mb-6 text-4xl shadow-xl">
                <i class="fas fa-server"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Erro de Conexão Local</h2>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 max-w-lg mx-auto text-left">
                <p class="text-slate-600 dark:text-slate-300 mb-4 font-medium">Use a extensão <strong>Live Server</strong> para rodar este aplicativo corretamente.</p>
            </div>
            <button onclick="location.reload()" class="mt-8 bg-brand-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-brand-700 transition shadow-lg flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Tentar Novamente
            </button>
        </div>

        <div id="screen-home" class="fade-in max-w-6xl mx-auto pb-24">
            <!-- Card para retomar simulado pausado -->
            <div id="paused-alert" class="hidden bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mb-6">
                <h3 class="text-lg font-bold text-amber-800 dark:text-amber-200">Simulado Pausado</h3>
                <p class="text-sm text-amber-600 dark:text-amber-300">Você tem um simulado em pausa. Deseja retomar?</p>
                <div class="mt-4 flex gap-3">
                    <button onclick="resumeSimulation()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-bold">Retomar Simulado</button>
                    <button onclick="discardPaused()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold">Descartar</button>
                </div>
            </div>

            <!-- Configuração do simulador -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-6 md:p-10 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
                    <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-2">Configurar Simulador</h2>
                    <p class="text-slate-500 dark:text-slate-400">Selecione os tópicos e a estratégia de distribuição.</p>
                </div>

                <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-7 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <label class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 uppercase tracking-wide text-sm">
                                <i class="fas fa-list-ul text-brand-500"></i> Assuntos Disponíveis
                            </label>
                            <div class="space-x-3">
                                <button onclick="toggleAllModules(true)" id="btn-select-all" class="text-xs font-bold text-brand-600 hover:underline">Todos</button>
                                <button onclick="toggleAllModules(false)" id="btn-select-none" class="text-xs font-bold text-slate-500 hover:text-red-500">Nenhum</button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-200 dark:border-slate-600 flex-grow max-h-[500px] overflow-y-auto custom-scrollbar p-1" id="module-container">
                            <div class="p-8 text-center text-slate-400"><div class="loader mx-auto mb-2"></div> Carregando módulos...</div>
                        </div>

                        <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Banco de Dados</span>
                                    <span id="badge-total" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Módulos Selecionados</span>
                                    <span id="badge-modules" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Q. Selecionadas</span>
                                    <span id="badge-available" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Para o Simulado</span>
                                    <span id="badge-target" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-blue-600 dark:text-blue-400 text-center">
                                <i class="fas fa-info-circle mr-1"></i> As questões foram elaboradas com IA e as de 2018 são do concurso anterior (atualizadas).
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-5 flex flex-col gap-6">
                        
                        <div class="bg-orange-50 dark:bg-orange-900/10 p-5 rounded-xl border border-orange-100 dark:border-orange-800/30 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 w-20 h-20 bg-orange-100 dark:bg-orange-800/20 rounded-bl-full -mr-4 -mt-4 transition group-hover:scale-110"></div>
                            <div class="relative z-10 flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-orange-800 dark:text-orange-200">Filtro Concurso 2018</div>
                                    <div class="text-[10px] text-orange-600 dark:text-orange-300 mt-1 max-w-[150px]">
                                        Trava a seleção apenas para questões da prova anterior.
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="filter-2018" class="sr-only peer" onchange="toggle2018Lock()">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div id="qty-selector-container">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Quantidade Total</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="setQuantity(5, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="5">5</button>
                                    <button onclick="setQuantity(10, event)" class="btn-qty p-2 rounded border bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30 dark:text-brand-300 text-sm font-medium transition" data-val="10">10</button>
                                    <button onclick="setQuantity(20, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="20">20</button>
                                    <button onclick="setQuantity(30, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="30">30</button>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <button onclick="setQuantity('all', event)" class="flex-1 btn-qty p-2 rounded border border-purple-200 text-purple-700 bg-purple-50 hover:bg-purple-100 text-xs font-bold uppercase transition" data-val="all">Selecionar Tudo</button>
                                    <input type="number" id="custom-qty" placeholder="Qtd..." class="w-20 p-2 text-sm border rounded text-center outline-none focus:border-brand-500 dark:bg-slate-700 dark:border-slate-600" oninput="setQuantity('custom', event)">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Modo de Distribuição</label>
                                <select id="distribution-mode" onchange="handleModeChange()" class="w-full p-2.5 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200">
                                    <option value="random">Aleatório Simples</option>
                                    <option value="balanced">Equilibrado (Por Tópico)</option>
                                    <option value="proportional">Proporcional (Peso)</option>
                                    <option value="manual">Manual / Personalizado</option>
                                </select>
                            </div>

                            <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600 p-3">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex justify-between">
                                    <span>Previsão do Simulado</span>
                                    <span id="preview-total" class="text-brand-600">0 questões</span>
                                </h4>
                                <div id="distribution-preview" class="max-h-[150px] overflow-y-auto custom-scrollbar space-y-1 text-xs text-slate-600 dark:text-slate-300">
                                    <p class="text-slate-400 italic">Selecione módulos para ver.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                    <button onclick="startSimulation()" class="w-full bg-brand-600 hover:bg-brand-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-0.5 flex justify-center items-center gap-3">
                        INICIAR SIMULADO <i class="fas fa-arrow-right"></i>
                    </button>
                    <div class="mt-4 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500 dark:text-slate-400">
                        <div class="text-center md:text-left">
                            <p>Desenvolvido por <strong>Marcos Guimarães Duailibi Filho</strong></p>
                            <p class="mt-0.5">Contato: +55 (95) 98111-4983</p>
                        </div>
                        
                        <div class="mt-2 md:mt-0 flex items-center gap-2 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-600" title="Uso do Armazenamento Local">
                            <i class="fas fa-database text-xs text-slate-400"></i>
                            <span class="font-mono text-[10px]" id="footer-cache-stat">0 KB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-quiz" class="hidden max-w-6xl mx-auto h-full flex flex-col fade-in pb-24">
            <!-- Tela do quiz -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 flex flex-col md:flex-row justify-between items-center mb-6 mobile-padding">
                <div class="flex items-center gap-6 mobile-stack">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Tempo</span>
                        <span class="font-mono font-bold text-lg text-slate-700 dark:text-slate-200" id="timer">00:00</span>
                    </div>
                    <div class="h-8 w-px bg-slate-200 dark:bg-slate-600"></div>
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Progresso</span>
                        <span class="font-bold text-lg text-slate-700 dark:text-slate-200">
                            <span id="q-current-index">1</span><span class="text-slate-400 text-sm">/</span><span id="q-total-count" class="text-sm text-slate-400">10</span>
                        </span>
                    </div>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button onclick="pauseSimulation()" id="btn-pause" class="text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 px-4 py-2 rounded-lg text-xs font-bold uppercase transition">
                        Pausar
                    </button>
                    <button onclick="abandonSimulation()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-lg text-xs font-bold uppercase transition">
                        Abandonar
                    </button>
                    <button onclick="finishSimulation()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-lg text-xs font-bold uppercase transition">
                        Finalizar
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                <div class="lg:col-span-9 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 md:p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100 dark:bg-slate-700">
                        <div id="progress-bar" class="h-full bg-brand-500 transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <span id="q-module-name" class="inline-block mt-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-4">Módulo</span>
                    
                    <h3 id="q-text" class="text-xl md:text-2xl text-slate-800 dark:text-slate-100 font-medium leading-relaxed mb-8 mobile-text-sm">...</h3>

                    <div id="options-container" class="space-y-3 mb-8"></div>

                    <div class="flex items-center justify-between pt-6 border-t border-slate-100 dark:border-slate-700 mobile-stack">
                        <button onclick="changeQuestion(-1)" id="btn-prev" class="text-slate-500 hover:text-brand-600 font-bold px-4 py-2 rounded transition disabled:opacity-30 mobile-full mb-2">
                            <i class="fas fa-arrow-left mr-2"></i> Anterior
                        </button>
                        <div class="flex gap-3 mobile-full">
                            <button id="btn-confirm" onclick="confirmAnswer()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold shadow transition disabled:opacity-50 disabled:cursor-not-allowed mobile-full">
                                Responder
                            </button>
                            <button onclick="changeQuestion(1)" id="btn-next" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full">
                                Pular
                            </button>
                        </div>
                    </div>

                    <div id="explanation-box" class="hidden mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-lg p-5 fade-in">
                        <h4 class="text-blue-800 dark:text-blue-300 font-bold text-sm mb-2 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> Comentário / Justificativa
                        </h4>
                        <p id="explanation-text" class="text-slate-700 dark:text-slate-300 text-sm leading-relaxed"></p>
                        <div class="mt-3 text-xs text-blue-600 dark:text-blue-400">
                            <i class="fas fa-info-circle mr-1"></i> Consulte o Regimento ao lado para verificar a precisão da explicação.
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5 sticky top-4">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Mapa</h4>
                    <div id="nav-grid" class="grid grid-cols-5 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
            </div>
        </div>

        <!-- Tela de pausa -->
        <div id="screen-pause" class="hidden fade-in max-w-4xl mx-auto mt-8 pb-24">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden text-center">
                <div class="bg-amber-500 p-10 text-white relative overflow-hidden">
                    <h2 class="text-3xl font-bold mb-2">Simulado Pausado</h2>
                    <p class="text-amber-100">Você pode retomar de onde parou.</p>
                </div>
                <div class="p-8 md:p-12">
                    <div class="grid grid-cols-3 gap-6 mb-10 mobile-stack">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border-b-4 border-blue-500">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="paused-progress">0/0</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Progresso</div>
                        </div>
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border-b-4 border-green-500">
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="paused-correct">0</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Acertos</div>
                        </div>
                        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-xl border-b-4 border-slate-400">
                            <div class="text-3xl font-bold text-slate-600 dark:text-slate-300" id="paused-time">00:00</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Tempo</div>
                        </div>
                    </div>

                    <div class="flex gap-4 justify-center mobile-stack">
                        <button onclick="resumeSimulation()" class="bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg mobile-full">Retomar Simulado</button>
                        <button onclick="abandonSimulation()" class="border border-slate-300 text-slate-700 px-8 py-3 rounded-lg font-bold hover:bg-slate-50 transition dark:border-slate-600 dark:text-white dark:hover:bg-slate-700 mobile-full">Abandonar</button>
                        <button onclick="showScreen('home')" class="border border-slate-300 text-slate-700 px-8 py-3 rounded-lg font-bold hover:bg-slate-50 transition dark:border-slate-600 dark:text-white dark:hover:bg-slate-700 mobile-full">Voltar ao Início</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-result" class="hidden fade-in max-w-4xl mx-auto mt-8 pb-24">
            <!-- Tela de resultados -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden text-center">
                <div class="bg-slate-900 p-10 text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-2">Resultado Final</h2>
                        <p class="text-slate-400">Confira seu desempenho.</p>
                    </div>
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                </div>
                
                <div class="p-8 md:p-12">
                    <div class="flex justify-center items-center mb-10">
                        <div class="chart-container">
                            <canvas id="resultChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-3xl font-bold text-slate-800 dark:text-white" id="res-percent">0%</span>
                                <span class="text-xs uppercase font-bold text-slate-400">Aproveitamento</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6 mb-10 mobile-stack">
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border-b-4 border-green-500">
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="res-correct">0</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Acertos</div>
                        </div>
                        <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border-b-4 border-red-500">
                            <div class="text-3xl font-bold text-red-600 dark:text-red-400" id="res-wrong">0</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Erros</div>
                        </div>
                        <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-xl border-b-4 border-slate-400">
                            <div class="text-3xl font-bold text-slate-600 dark:text-slate-300" id="res-unanswered">0</div>
                            <div class="text-xs font-bold uppercase text-slate-500">Branco</div>
                        </div>
                    </div>

                    <div class="flex gap-4 justify-center mobile-stack">
                        <button onclick="location.reload()" class="bg-brand-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-brand-700 transition shadow-lg mobile-full">Novo Simulado</button>
                        <button onclick="showScreen('analytics')" class="border border-slate-300 text-slate-700 px-8 py-3 rounded-lg font-bold hover:bg-slate-50 transition dark:border-slate-600 dark:text-white dark:hover:bg-slate-700 mobile-full">Histórico</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-analytics" class="hidden fade-in max-w-7xl mx-auto pb-24">
            <div class="flex justify-between items-end mb-6 mobile-stack">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Análise Avançada de Desempenho</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Métricas detalhadas e gráficos 3D interativos.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportHistoryCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    <button onclick="importHistoryCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-upload"></i> Importar CSV
                    </button>
                </div>
            </div>

            <!-- Métricas Rápidas - PRIMEIRA LINHA -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Média Geral</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="avg-overall">0%</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                            <i class="fas fa-chart-line text-blue-600 dark:text-blue-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="avg-trend">Carregando...</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Tempo Médio/Q</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="avg-time-per-q">0s</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                            <i class="fas fa-clock text-green-600 dark:text-green-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="time-trend">Carregando...</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Melhor Módulo</div>
                            <div class="text-xl font-bold text-slate-800 dark:text-white truncate" id="best-module">-</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center">
                            <i class="fas fa-trophy text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="best-module-score">0%</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Pior Módulo</div>
                            <div class="text-xl font-bold text-slate-800 dark:text-white truncate" id="worst-module">-</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="worst-module-score">0%</div>
                </div>
            </div>

            <!-- Métricas Rápidas - SEGUNDA LINHA (Indicadores de Evolução) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Evolução 1 dia</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="evolution-1d">0%</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                            <i class="fas fa-calendar-day text-purple-600 dark:text-purple-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="evolution-1d-trend">Carregando...</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Evolução 2 dias</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="evolution-2d">0%</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="evolution-2d-trend">Carregando...</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Evolução 7 dias</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="evolution-7d">0%</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center">
                            <i class="fas fa-calendar-week text-pink-600 dark:text-pink-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="evolution-7d-trend">Carregando...</div>
                </div>
                
                <div class="metric-card bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase">Evolução 30 dias</div>
                            <div class="text-2xl font-bold text-slate-800 dark:text-white" id="evolution-30d">0%</div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center">
                            <i class="fas fa-calendar text-teal-600 dark:text-teal-400"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 dark:text-slate-400" id="evolution-30d-trend">Carregando...</div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 mb-6">
                <div class="flex bg-white dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
                    <button onclick="setHistoryFilter('days', 'all')" class="px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700" id="hist-filter-all">Tudo</button>
                    <button onclick="setHistoryFilter('days', 1)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="hist-filter-1">1 Dia</button>
                    <button onclick="setHistoryFilter('days', 2)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="hist-filter-2">2 Dias</button>
                    <button onclick="setHistoryFilter('days', 7)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="hist-filter-7">7 Dias</button>
                    <button onclick="setHistoryFilter('days', 30)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="hist-filter-30">30 Dias</button>
                </div>
                
                <!-- Corrigido: O filtro agora só mostra módulos que realmente têm questões respondidas -->
                <select id="module-filter" onchange="setHistoryFilter('module', this.value)" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm min-w-[200px]">
                    <option value="all">Todos os módulos</option>
                </select>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                    <i class="fas fa-info-circle mr-1"></i> Filtre por módulo para análise específica
                </div>
            </div>
            
            <!-- Gráficos 2D - Agora com 3 gráficos (linha, barras, pizza) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Evolução do Desempenho</h3>
                    <div class="h-64 relative w-full">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Distribuição de Resultados</h3>
                    <div class="h-64 relative w-full">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Distribuição por Módulo</h3>
                    <div class="h-64 relative w-full">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico de Tendência (Linha) -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Tendência de Aproveitamento</h3>
                <div class="h-64 relative w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <!-- Seção de Análise Tridimensional com Plotly.js -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Análise Tridimensional com Métricas Avançadas</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Gráficos 3D interativos com tabelas de métricas evolutivas. Os pontos são interligados para mostrar progressão temporal.</p>

                <!-- Filtros para gráficos 3D -->
                <div class="flex flex-wrap items-center gap-4 mb-6">
                    <div class="flex bg-white dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
                        <button onclick="set3dFilter('days', 'all')" class="px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700" id="3d-filter-all">Tudo</button>
                        <button onclick="set3dFilter('days', 1)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="3d-filter-1">1 Dia</button>
                        <button onclick="set3dFilter('days', 7)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="3d-filter-7">7 Dias</button>
                        <button onclick="set3dFilter('days', 30)" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700" id="3d-filter-30">30 Dias</button>
                    </div>
                    
                    <select id="3d-module-filter" onchange="set3dFilter('module', this.value)" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm min-w-[200px]">
                        <option value="all">Todos os módulos</option>
                    </select>

                    <div class="text-xs text-slate-500 dark:text-slate-400">
                        <i class="fas fa-info-circle mr-1"></i> Arraste para girar, use a roda para zoom. Linhas conectam a evolução temporal.
                    </div>
                </div>

                <!-- Gráfico 3D Geral (AGORA COM Plotly.js e tabela de métricas) -->
                <div id="overall-3d-section" class="mb-8">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">Gráfico 3D Geral: Tempo vs Questões vs Módulos</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Relação entre tempo médio de resposta (eixo Z), número total de questões (eixo X) e quantidade de módulos (eixo Y). Linhas mostram evolução temporal.
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                            <div class="lg:col-span-2">
                                <div id="overall3dChart" class="plotly-3d-container"></div>
                                <div class="plotly-error hidden" id="overall3dError">
                                    Falha ao carregar gráfico 3D.
                                </div>
                            </div>
                            
                            <div class="lg:col-span-1">
                                <div class="bg-slate-50 dark:bg-slate-700/30 rounded-lg p-4 h-full">
                                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                        <i class="fas fa-table"></i> Métricas por Simulado
                                    </h4>
                                    <div class="metrics-table-container">
                                        <table class="w-full text-sm">
                                            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-800">
                                                <tr class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">
                                                    <th class="px-3 py-2 text-left">Data</th>
                                                    <th class="px-3 py-2 text-left">Q</th>
                                                    <th class="px-3 py-2 text-left">M</th>
                                                    <th class="px-3 py-2 text-left">Tempo</th>
                                                    <th class="px-3 py-2 text-left">%</th>
                                                    <th class="px-3 py-2 text-left">Δ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overall3dTable" class="divide-y divide-slate-200 dark:divide-slate-700">
                                                <!-- Preenchido por JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <div class="text-xs font-bold text-blue-700 dark:text-blue-300 mb-1">Legenda</div>
                                        <div class="text-xs text-slate-600 dark:text-slate-400">
                                            <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-green-500"></div> ≥70%</div>
                                            <div class="flex items-center gap-2 mb-1"><div class="w-3 h-3 rounded-full bg-yellow-500"></div> 50-70%</div>
                                            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div> <50%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-slate-100 dark:border-slate-700">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-blue-700 dark:text-blue-300">Eixo X</div>
                                    <div class="font-bold">Total de Questões</div>
                                </div>
                                <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-green-700 dark:text-green-300">Eixo Y</div>
                                    <div class="font-bold">Quantidade de Módulos</div>
                                </div>
                                <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-purple-700 dark:text-purple-300">Eixo Z</div>
                                    <div class="font-bold">Tempo Médio (segundos)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico 3D por Módulo (AGORA COM Plotly.js e tabela de métricas) -->
                <div id="module-3d-section" class="mb-8">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">Gráfico 3D por Módulo: Desempenho Detalhado</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Relação entre tempo médio por questão (eixo Z), número de questões do módulo (eixo X) e desempenho percentual (eixo Y). Linhas conectam por ordem de desempenho.
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                            <div class="lg:col-span-2">
                                <div id="module3dChart" class="plotly-3d-container"></div>
                                <div class="plotly-error hidden" id="module3dError">
                                    Falha ao carregar gráfico 3D.
                                </div>
                            </div>
                            
                            <div class="lg:col-span-1">
                                <div class="bg-slate-50 dark:bg-slate-700/30 rounded-lg p-4 h-full">
                                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                        <i class="fas fa-chart-bar"></i> Métricas por Módulo
                                    </h4>
                                    <div class="metrics-table-container">
                                        <table class="w-full text-sm">
                                            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-800">
                                                <tr class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">
                                                    <th class="px-3 py-2 text-left">Módulo</th>
                                                    <th class="px-3 py-2 text-left">Q/M</th>
                                                    <th class="px-3 py-2 text-left">%</th>
                                                    <th class="px-3 py-2 text-left">Tempo</th>
                                                    <th class="px-3 py-2 text-left">Sim</th>
                                                    <th class="px-3 py-2 text-left">Evol</th>
                                                </tr>
                                            </thead>
                                            <tbody id="module3dTable" class="divide-y divide-slate-200 dark:divide-slate-700">
                                                <!-- Preenchido por JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                        <div class="text-xs font-bold text-purple-700 dark:text-purple-300 mb-1">Interpretação</div>
                                        <div class="text-xs text-slate-600 dark:text-slate-400">
                                            <div class="mb-1"><span class="font-bold">Q/M:</span> Questões por módulo (média)</div>
                                            <div class="mb-1"><span class="font-bold">Sim:</span> Número de simulações</div>
                                            <div><span class="font-bold">Evol:</span> Evolução vs anterior (↑ melhora)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-slate-100 dark:border-slate-700">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-blue-700 dark:text-blue-300">Eixo X</div>
                                    <div class="font-bold">Questões por Módulo</div>
                                </div>
                                <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-green-700 dark:text-green-300">Eixo Y</div>
                                    <div class="font-bold">Desempenho (%)</div>
                                </div>
                                <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                    <div class="text-xs font-bold text-purple-700 dark:text-purple-300">Eixo Z</div>
                                    <div class="font-bold">Tempo por Questão (s)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela 1: Histórico Total -->
            <div class="mb-6">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Histórico Completo de Simulados</h3>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50">
                        <div class="flex justify-between items-center">
                            <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300">Todos os simulados (filtrado por período)</h4>
                            <span class="text-xs text-slate-500 dark:text-slate-400" id="history-count">0 registros</span>
                        </div>
                    </div>
                    <div class="max-h-[400px] overflow-y-auto">
                        <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                            <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 text-xs uppercase font-bold text-slate-500">
                                <tr>
                                    <th class="px-6 py-4">Data</th>
                                    <th class="px-6 py-4">Módulo(s)</th>
                                    <th class="px-6 py-4">Acertos</th>
                                    <th class="px-6 py-4">Erros</th>
                                    <th class="px-6 py-4">Branco</th>
                                    <th class="px-6 py-4">Tempo/Q</th>
                                    <th class="px-6 py-4 text-right">Nota</th>
                                </tr>
                            </thead>
                            <tbody id="history-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                    <div id="no-history" class="p-10 text-center text-slate-400 hidden">
                        <i class="fas fa-inbox mb-4 text-3xl"></i>
                        <p>Nenhum simulado realizado no período.</p>
                    </div>
                </div>
            </div>

            <!-- Tabela 2: Detalhada por Módulo -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Análise Detalhada por Módulo</h3>
                        <span class="text-xs text-slate-500 dark:text-slate-400" id="module-detail-description">
                            Mostrando todos os módulos
                        </span>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto">
                    <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                        <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 text-xs uppercase font-bold text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Data</th>
                                <th class="px-6 py-4">Módulo</th>
                                <th class="px-6 py-4">Acertos</th>
                                <th class="px-6 py-4">Erros</th>
                                <th class="px-6 py-4">Branco</th>
                                <th class="px-6 py-4">Total</th>
                                <th class="px-6 py-4">Tempo/Q</th>
                                <th class="px-6 py-4 text-right">Nota</th>
                            </tr>
                        </thead>
                        <tbody id="module-detail-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                    </table>
                </div>
                <div id="no-module-detail" class="p-10 text-center text-slate-400 hidden">
                    <i class="fas fa-info-circle mb-2 block text-2xl"></i>
                    <p>Selecione um módulo específico no filtro acima para ver detalhes por módulo.</p>
                </div>
            </div>
        </div>

    </main>

    <div id="pdf-drawer" class="fixed top-16 right-0 w-[90%] md:w-[600px] h-[calc(100vh-4rem)] bg-white dark:bg-slate-800 shadow-2xl border-l border-slate-200 dark:border-slate-700 z-50 transform translate-x-full flex flex-col transition-transform duration-300">
        <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
            <span class="font-bold text-sm text-slate-700 dark:text-slate-200"><i class="fas fa-book mr-2"></i> Regimento Interno</span>
            <div class="flex gap-2">
                <a href="src/regimento-interno-2023-ale-rr-ok.pdf" target="_blank" class="text-xs text-brand-600 hover:underline flex items-center"><i class="fas fa-external-link-alt mr-1"></i> Abrir Janela</a>
                <button onclick="togglePdfDrawer()" class="w-6 h-6 rounded hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="flex-grow bg-slate-200 relative">
            <object data="src/regimento-interno-2023-ale-rr-ok.pdf" type="application/pdf" class="w-full h-full">
                <div class="flex flex-col items-center justify-center h-full text-slate-500 p-4 text-center">
                    <p>Visualizador indisponível.</p>
                    <a href="src/regimento-interno-2023-ale-rr-ok.pdf" target="_blank" class="text-brand-600 font-bold underline mt-2">Baixar PDF</a>
                </div>
            </object>
        </div>
        <div onclick="togglePdfDrawer()" class="absolute left-0 top-1/2 -translate-x-full cursor-pointer bg-red-600 text-white py-4 px-1 rounded-l-lg shadow-lg hover:bg-red-700 transition pdf-tab z-50 flex items-center gap-2 justify-center" title="Abrir Regimento">
             <i class="fas fa-book-open rotate-90 mb-2"></i> <span class="font-bold text-xs tracking-widest uppercase">Regimento</span>
        </div>
    </div>

    <div id="cache-modal" class="fixed inset-0 z-[80] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-200 dark:border-slate-700 transform transition-all">
            <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fas fa-database text-blue-500"></i> Gerenciar Dados</h3>
                <button onclick="toggleCacheModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <div class="flex justify-between text-sm mb-2 text-slate-600 dark:text-slate-300">
                        <span>Uso do Cache</span>
                        <span id="cache-usage-text" class="font-mono font-bold">0 KB</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                        <div id="cache-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                    <div>
                        <span class="block text-sm font-bold text-slate-700 dark:text-slate-200">Salvar Histórico</span>
                        <span class="text-[10px] text-slate-500 dark:text-slate-400">Armazenar resultados automaticamente.</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-save-history" class="sr-only peer" checked onchange="toggleHistorySaving()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Limpar por período</label>
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <button onclick="clearHistory('1h')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">1H</button>
                        <button onclick="clearHistory('2h')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">2H</button>
                        <button onclick="clearHistory('4h')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">4H</button>
                        <button onclick="clearHistory('24h')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">24H</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="clearHistory('week')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">1 Semana</button>
                        <button onclick="clearHistory('month')" class="py-2 rounded bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-xs font-bold">1 Mês</button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="custom-date-clear" class="flex-1 py-1.5 px-2 text-xs border rounded dark:bg-slate-700 dark:border-slate-600">
                        <button onclick="clearHistory('custom')" class="py-1.5 px-3 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 text-xs font-bold rounded">Limpar Antes De</button>
                    </div>
                </div>

                <button onclick="clearHistory('all')" class="w-full py-3 px-4 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 text-sm font-bold transition border border-red-200 dark:border-red-900">
                    <i class="fas fa-trash-alt mr-2"></i> Apagar Todo o Cache
                </button>
            </div>
        </div>
    </div>

    <div id="warning-modal" class="fixed inset-0 z-[90] bg-black/60 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 max-w-sm text-center border border-slate-200 dark:border-slate-600 transform scale-100 transition-transform">
            <div class="w-14 h-14 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Quantidade Indisponível</h3>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-6">Você solicitou mais questões do que as selecionadas atualmente. Ajuste o filtro ou diminua a quantidade.</p>
            <button onclick="document.getElementById('warning-modal').classList.add('hidden')" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg w-full transition">
                Entendi
            </button>
        </div>
    </div>

    <div id="csv-import-modal" class="fixed inset-0 z-[100] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-200 dark:border-slate-700">
            <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fas fa-file-import text-green-500"></i> Importar Histórico CSV</h3>
                <button onclick="closeCSVImportModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
                    Selecione um arquivo CSV no formato exportado por este sistema.
                </p>
                <input type="file" id="csv-file-input" accept=".csv" class="w-full p-2 border border-slate-300 rounded dark:bg-slate-700 dark:border-slate-600 mb-4">
                <div class="flex justify-end gap-3">
                    <button onclick="closeCSVImportModal()" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">Cancelar</button>
                    <button onclick="processCSVImport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold">Importar</button>
                </div>
            </div>
        </div>
    </div>

  </div>

  <script>
    const DB_FILES = [
      'src/da-interpretacao-e-observancia-do-regimento-titulo-VI.json',
      'src/da-ordem-interna-da-assembleia-titulo-IX.json',
      'src/da-participacao-da-sociedade-civil.titulo-IV.json',
      'src/da-representacao-parlamentar-titulo-III.json',
      'src/das-disposicoes-finais-titulo-XI.json',
      'src/disposicoes-preliminares-titulo-I.json',
      'src/do-processo-por-crime-de-responsabilidade-da-convocacao-de-secretarios-e-do-credenciamento-de-imprensa-titulo-X.json',
      'src/dos-debates-e-das-deliberacoes-titulo-VIII.json',
      'src/orgaos-da-assembleia-titulo-II.json',
      'src/questoes-concurso-2018.json',
      'src/sessoes-da-assembleia-titulo-V.json'
    ];

    // Variáveis Globais de Chart.js (2D)
    let historyChartInstance = null;
    let distributionChartInstance = null;
    let trendChartInstance = null;
    let resultChartInstance = null;
    let pieChartInstance = null;
    
    // Variáveis para Plotly.js (3D)
    let overall3dChartInstance = null;
    let module3dChartInstance = null;
    
    let fullDatabase = [];
    let availableModules = [];
    let historyFilters = {
        days: 'all',
        module: 'all'
    };

    let analytics3dFilters = {
        days: 'all',
        module: 'all'
    };
    
    let appState = {
        questions: [],
        index: 0,
        answers: [],
        timer: null,
        config: { qty: 10, modules: [], filter2018: false, mode: 'random' },
        moduleCounts: {}, 
        moduleCounts2018: {}, 
        distribution: {},
        savingEnabled: true,
        startTime: null,
        isPaused: false
    };

    // Funções auxiliares
    function showScreen(id) { 
        ['home','quiz','result','analytics','error','pause'].forEach(s => {
            const screen = document.getElementById('screen-'+s);
            if (screen) screen.classList.add('hidden');
        }); 
        
        const targetScreen = document.getElementById('screen-'+id);
        if (targetScreen) {
            targetScreen.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        if(id === 'home') {
            updateDistribution();
            // Verifica se há simulado pausado
            const paused = localStorage.getItem('alerr_paused_sim');
            if (paused) {
                document.getElementById('paused-alert').classList.remove('hidden');
            }
        } else if (id === 'analytics') {
            setTimeout(() => {
                applyHistoryFilters();
                update3dCharts();
                updateMetricsCards();
            }, 100);
        }
    }
    
    function togglePdfDrawer() { 
        const d = document.getElementById('pdf-drawer'); 
        d.classList.toggle('translate-x-full'); 
        d.classList.toggle('drawer-open'); 
    }
    
    function initTheme() { 
        if(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        updateThemeIcon();
    }
    
    function toggleDarkMode() { 
        document.documentElement.classList.toggle('dark'); 
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        updateThemeIcon();
        
        update3dCharts();
    }

    function updateThemeIcon() {
        const themeIcon = document.getElementById('theme-icon');
        if (document.documentElement.classList.contains('dark')) {
            themeIcon.className = 'fas fa-sun';
        } else {
            themeIcon.className = 'fas fa-moon';
        }
    }

    // ============================================
    // FUNÇÕES DE PAUSA, RETOMADA E ABANDONO
    // ============================================

    function pauseSimulation() {
        // Calcula o tempo decorrido
        const now = new Date();
        const elapsed = Math.floor((now - appState.startTime) / 1000);

        // Salva o estado do simulado
        const pausedState = {
            questions: appState.questions,
            answers: appState.answers,
            index: appState.index,
            config: appState.config,
            elapsedTime: elapsed,
            datePaused: new Date().toISOString()
        };

        // Salva no localStorage
        localStorage.setItem('alerr_paused_sim', JSON.stringify(pausedState));

        // Para o timer
        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }

        // Atualiza a tela de pausa com os dados atuais
        updatePauseScreen(pausedState);

        // Marca como pausado
        appState.isPaused = true;

        // Mostra a tela de pausa
        showScreen('pause');
    }

    function updatePauseScreen(pausedState) {
        const total = pausedState.questions.length;
        const current = pausedState.index + 1;
        document.getElementById('paused-progress').textContent = `${current}/${total}`;

        // Calcula acertos até agora
        let correct = 0;
        for (let i = 0; i < pausedState.answers.length; i++) {
            if (pausedState.answers[i].ok && pausedState.answers[i].isCorrect) {
                correct++;
            }
        }
        document.getElementById('paused-correct').textContent = correct;

        // Formata o tempo decorrido
        const minutes = Math.floor(pausedState.elapsedTime / 60).toString().padStart(2, '0');
        const seconds = (pausedState.elapsedTime % 60).toString().padStart(2, '0');
        document.getElementById('paused-time').textContent = `${minutes}:${seconds}`;
    }

    function resumeSimulation() {
        // Carrega o estado pausado
        const pausedState = localStorage.getItem('alerr_paused_sim');
        
        if (!pausedState) {
            alert('Não há simulado pausado.');
            return;
        }

        const state = JSON.parse(pausedState);

        // Restaura o estado
        appState.questions = state.questions;
        appState.answers = state.answers;
        appState.index = state.index;
        appState.config = state.config;

        // Ajusta o startTime para considerar o tempo já decorrido
        const now = new Date();
        const adjustedStartTime = new Date(now.getTime() - (state.elapsedTime * 1000));
        appState.startTime = adjustedStartTime;

        // Remove o estado pausado do localStorage
        localStorage.removeItem('alerr_paused_sim');

        // Esconde o alerta de pausado na tela inicial
        document.getElementById('paused-alert').classList.add('hidden');

        // Reinicia o timer
        startTimer();

        // Carrega a questão atual
        loadQuestion(appState.index);
        renderNav();

        // Mostra a tela do quiz
        showScreen('quiz');
    }

    function discardPaused() {
        if (confirm('Tem certeza que deseja descartar o simulado pausado? Esta ação não pode ser desfeita.')) {
            localStorage.removeItem('alerr_paused_sim');
            document.getElementById('paused-alert').classList.add('hidden');
        }
    }

    function abandonSimulation() {
        if (!confirm('Tem certeza que deseja abandonar o simulado? Todo o progresso será perdido e não será salvo no histórico.')) {
            return;
        }

        // Para o timer
        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }

        // Remove o estado pausado se existir
        localStorage.removeItem('alerr_paused_sim');

        // Reseta o estado
        appState.questions = [];
        appState.answers = [];
        appState.index = 0;
        appState.isPaused = false;

        // Mostra a tela inicial
        showScreen('home');
    }

    // ============================================
    // FUNÇÕES PLOTLY.JS (3D) COM TABELAS
    // ============================================

    // Inicializa os gráficos 3D com Plotly.js
    function init3dCharts() {
        console.log("Plotly.js carregado e pronto para gráficos 3D");
    }

    // Atualiza gráfico 3D Geral com dados do histórico
    function renderOverall3dChart(historyData) {
        const container = document.getElementById('overall3dChart');
        if (!container || historyData.length === 0) {
            document.getElementById('overall3dError').classList.remove('hidden');
            document.getElementById('overall3dTable').innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-slate-500">Nenhum dado disponível</td></tr>';
            return;
        }

        // Ordenar por data para linha evolutiva
        const sortedData = [...historyData].sort((a, b) => new Date(a.date) - new Date(b.date));

        // Preparar dados para o gráfico 3D
        const xData = [];
        const yData = [];
        const zData = [];
        const colors = [];
        const sizes = [];
        const hoverTexts = [];
        const dates = [];

        // Encontrar valores máximos para normalização
        let maxQuestions = 1;
        let maxModules = 1;
        let maxTime = 1;

        sortedData.forEach(item => {
            const moduleCount = Object.keys(item.modules || {}).length;
            const avgTime = item.total > 0 ? (item.duration || 0) / item.total : 0;
            
            maxQuestions = Math.max(maxQuestions, item.total || 1);
            maxModules = Math.max(maxModules, moduleCount || 1);
            maxTime = Math.max(maxTime, avgTime || 1);
        });

        // Preparar dados
        sortedData.forEach((item, index) => {
            const moduleCount = Object.keys(item.modules || {}).length;
            const avgTime = item.total > 0 ? (item.duration || 0) / item.total : 0;
            
            xData.push(item.total || 0);
            yData.push(moduleCount);
            zData.push(avgTime);
            dates.push(new Date(item.date));
            
            // Tamanho baseado no número de questões
            const size = 8 + (item.total / maxQuestions) * 12;
            sizes.push(size);
            
            // Cor baseada no desempenho
            let color;
            if (item.percent >= 70) {
                color = '#22c55e'; // Verde
            } else if (item.percent >= 50) {
                color = '#eab308'; // Amarelo
            } else {
                color = '#ef4444'; // Vermelho
            }
            colors.push(color);
            
            // Texto de hover
            const date = new Date(item.date).toLocaleDateString('pt-BR');
            hoverTexts.push(
                `Data: ${date}<br>` +
                `Questões: ${item.total}<br>` +
                `Módulos: ${moduleCount}<br>` +
                `Tempo médio: ${avgTime.toFixed(1)}s<br>` +
                `Desempenho: ${item.percent}%`
            );
        });

        // Configurar layout do tema
        const isDark = document.documentElement.classList.contains('dark');
        const bgColor = isDark ? '#1e293b' : '#f8fafc';
        const textColor = isDark ? '#e2e8f0' : '#334155';
        const gridColor = isDark ? '#475569' : '#cbd5e1';

        // Criar trace de marcadores
        const markerTrace = {
            x: xData,
            y: yData,
            z: zData,
            mode: 'markers',
            type: 'scatter3d',
            marker: {
                size: sizes,
                color: colors,
                opacity: 0.8,
                line: {
                    color: isDark ? '#ffffff' : '#000000',
                    width: 1
                }
            },
            text: hoverTexts,
            hoverinfo: 'text',
            name: 'Simulados'
        };

        // Criar trace de linha evolutiva
        const lineTrace = {
            x: xData,
            y: yData,
            z: zData,
            mode: 'lines',
            type: 'scatter3d',
            line: {
                color: isDark ? '#60a5fa' : '#3b82f6',
                width: 2,
                dash: 'dash'
            },
            opacity: 0.6,
            hoverinfo: 'none',
            name: 'Evolução Temporal'
        };

        const layout = {
            title: {
                text: 'Relação Tempo vs Questões vs Módulos',
                font: {
                    color: textColor,
                    size: 14
                }
            },
            scene: {
                xaxis: {
                    title: {
                        text: 'Total de Questões',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                yaxis: {
                    title: {
                        text: 'Quantidade de Módulos',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                zaxis: {
                    title: {
                        text: 'Tempo Médio (segundos)',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                bgcolor: bgColor,
                camera: {
                    eye: { x: 1.5, y: 1.5, z: 1.5 }
                }
            },
            paper_bgcolor: bgColor,
            plot_bgcolor: bgColor,
            font: { color: textColor },
            margin: { l: 0, r: 0, b: 0, t: 40 },
            showlegend: true,
            legend: {
                x: 0.1,
                y: 0.9,
                font: { color: textColor }
            }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['select2d', 'lasso2d']
        };

        // Renderizar ou atualizar gráfico
        Plotly.newPlot(container, [markerTrace, lineTrace], layout, config)
            .then(() => {
                document.getElementById('overall3dError').classList.add('hidden');
                overall3dChartInstance = container;
                fillOverall3dTable(sortedData);
            })
            .catch(error => {
                console.error('Erro ao renderizar gráfico 3D geral:', error);
                document.getElementById('overall3dError').classList.remove('hidden');
            });
    }

    // Preencher tabela de métricas para gráfico geral
    function fillOverall3dTable(data) {
        const tableBody = document.getElementById('overall3dTable');
        if (!tableBody || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-slate-500">Nenhum dado disponível</td></tr>';
            return;
        }

        // Ordenar por data (mais recente primeiro)
        const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let tableHTML = '';
        let previousPercent = null;
        
        sortedData.forEach((item, index) => {
            const date = new Date(item.date);
            const moduleCount = Object.keys(item.modules || {}).length;
            const avgTime = item.total > 0 ? (item.duration || 0) / item.total : 0;
            const formattedDate = date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
            const formattedTime = avgTime.toFixed(1);

            // Calcular variação em relação ao anterior
            let variation = '';
            let variationClass = '';
            if (previousPercent !== null && index > 0) {
                const diff = item.percent - previousPercent;
                if (diff > 0) {
                    variation = `+${diff.toFixed(1)}`;
                    variationClass = 'text-green-600 dark:text-green-400';
                } else if (diff < 0) {
                    variation = `${diff.toFixed(1)}`;
                    variationClass = 'text-red-600 dark:text-red-400';
                } else {
                    variation = '0.0';
                    variationClass = 'text-slate-500';
                }
            } else {
                variation = '-';
                variationClass = 'text-slate-400';
            }
            
            previousPercent = item.percent;

            // Determinar ícone de tendência
            let trendIcon = '';
            if (variation !== '-' && variation !== '0.0') {
                if (variation.startsWith('+')) {
                    trendIcon = '<i class="fas fa-arrow-up text-green-500"></i>';
                } else {
                    trendIcon = '<i class="fas fa-arrow-down text-red-500"></i>';
                }
            }

            tableHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td class="px-3 py-2 text-xs font-mono">${formattedDate}</td>
                    <td class="px-3 py-2 font-bold">${item.total}</td>
                    <td class="px-3 py-2">${moduleCount}</td>
                    <td class="px-3 py-2">${formattedTime}s</td>
                    <td class="px-3 py-2 font-bold ${item.percent >= 70 ? 'text-green-600' : item.percent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${item.percent}%</td>
                    <td class="px-3 py-2 ${variationClass}">${trendIcon} ${variation}</td>
                </tr>
            `;
        });

        tableBody.innerHTML = tableHTML;
    }

    // Atualiza gráfico 3D por Módulo
    function renderModule3dChart(historyData) {
        const container = document.getElementById('module3dChart');
        if (!container) {
            document.getElementById('module3dError').classList.remove('hidden');
            document.getElementById('module3dTable').innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-slate-500">Nenhum dado disponível</td></tr>';
            return;
        }

        // Coletar dados agregados por módulo
        const moduleDataMap = new Map();
        const moduleEvolutionMap = new Map(); // Para evolução por módulo
        
        historyData.forEach(item => {
            Object.entries(item.modules || {}).forEach(([moduleName, moduleStats]) => {
                if (analytics3dFilters.module !== 'all' && analytics3dFilters.module !== moduleName) {
                    return;
                }
                
                if (!moduleDataMap.has(moduleName)) {
                    moduleDataMap.set(moduleName, {
                        totalQuestions: 0,
                        totalTime: 0,
                        totalCorrect: 0,
                        totalSimulations: 0,
                        performances: [], // Para calcular evolução
                        dates: []
                    });
                }
                
                const moduleData = moduleDataMap.get(moduleName);
                const timePerQuestion = item.total > 0 ? (item.duration || 0) / item.total : 0;
                const performance = moduleStats.total > 0 ? (moduleStats.correct / moduleStats.total) * 100 : 0;
                
                moduleData.totalQuestions += moduleStats.total;
                moduleData.totalTime += timePerQuestion * moduleStats.total;
                moduleData.totalCorrect += moduleStats.correct;
                moduleData.totalSimulations += 1;
                moduleData.performances.push(performance);
                moduleData.dates.push(new Date(item.date));
                
                // Armazenar para evolução
                if (!moduleEvolutionMap.has(moduleName)) {
                    moduleEvolutionMap.set(moduleName, []);
                }
                moduleEvolutionMap.get(moduleName).push({
                    date: new Date(item.date),
                    performance: performance,
                    questions: moduleStats.total,
                    time: timePerQuestion
                });
            });
        });
        
        if (moduleDataMap.size === 0) {
            document.getElementById('module3dError').classList.remove('hidden');
            document.getElementById('module3dTable').innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-slate-500">Nenhum dado disponível</td></tr>';
            return;
        }

        // Preparar dados para o gráfico
        const graphData = [];
        moduleDataMap.forEach((data, moduleName) => {
            const avgQuestions = data.totalQuestions / data.totalSimulations;
            const avgPerformance = data.totalQuestions > 0 ? 
                (data.totalCorrect / data.totalQuestions) * 100 : 0;
            const avgTime = data.totalQuestions > 0 ? 
                data.totalTime / data.totalQuestions : 0;
            
            // Calcular evolução (diferença entre primeira e última performance)
            let evolution = 0;
            if (data.performances.length >= 2) {
                const first = data.performances[0];
                const last = data.performances[data.performances.length - 1];
                evolution = last - first;
            }
            
            graphData.push({
                moduleName,
                avgQuestions,
                avgPerformance,
                avgTime,
                totalSimulations: data.totalSimulations,
                totalQuestions: data.totalQuestions,
                totalCorrect: data.totalCorrect,
                evolution: evolution
            });
        });

        // Ordenar por desempenho para linha evolutiva
        const sortedGraphData = [...graphData].sort((a, b) => a.avgPerformance - b.avgPerformance);

        // Preparar arrays para o gráfico
        const xData = sortedGraphData.map(d => d.avgQuestions);
        const yData = sortedGraphData.map(d => d.avgPerformance);
        const zData = sortedGraphData.map(d => d.avgTime);
        const colors = [];
        const sizes = [];
        const hoverTexts = [];
        const labels = [];

        // Encontrar valores máximos para normalização
        const maxQuestions = Math.max(...xData, 1);
        const maxPerformance = Math.max(...yData, 1);

        sortedGraphData.forEach(item => {
            labels.push(item.moduleName);
            
            // Tamanho baseado no número de simulações
            const size = 8 + (item.totalSimulations * 1.5);
            sizes.push(size);
            
            // Cor baseada no desempenho
            let color;
            if (item.avgPerformance >= 70) {
                color = '#22c55e'; // Verde
            } else if (item.avgPerformance >= 50) {
                color = '#eab308'; // Amarelo
            } else {
                color = '#ef4444'; // Vermelho
            }
            colors.push(color);
            
            // Texto de hover
            hoverTexts.push(
                `Módulo: ${item.moduleName}<br>` +
                `Questões/média: ${item.avgQuestions.toFixed(1)}<br>` +
                `Desempenho: ${item.avgPerformance.toFixed(1)}%<br>` +
                `Tempo/q: ${item.avgTime.toFixed(1)}s<br>` +
                `Simulações: ${item.totalSimulations}<br>` +
                `Evolução: ${item.evolution > 0 ? '+' : ''}${item.evolution.toFixed(1)}%`
            );
        });

        // Configurar layout do tema
        const isDark = document.documentElement.classList.contains('dark');
        const bgColor = isDark ? '#1e293b' : '#f8fafc';
        const textColor = isDark ? '#e2e8f0' : '#334155';
        const gridColor = isDark ? '#475569' : '#cbd5e1';

        // Criar trace de marcadores
        const markerTrace = {
            x: xData,
            y: yData,
            z: zData,
            mode: 'markers',
            type: 'scatter3d',
            marker: {
                size: sizes,
                color: colors,
                opacity: 0.8,
                line: {
                    color: isDark ? '#ffffff' : '#000000',
                    width: 1
                }
            },
            text: hoverTexts,
            hoverinfo: 'text',
            name: 'Módulos'
        };

        // Criar trace de linha (conectando por ordem de desempenho)
        const lineTrace = {
            x: xData,
            y: yData,
            z: zData,
            mode: 'lines',
            type: 'scatter3d',
            line: {
                color: isDark ? '#a78bfa' : '#8b5cf6',
                width: 2,
                dash: 'dot'
            },
            opacity: 0.5,
            hoverinfo: 'none',
            name: 'Ordem de Desempenho'
        };

        const layout = {
            title: {
                text: 'Desempenho por Módulo',
                font: {
                    color: textColor,
                    size: 14
                }
            },
            scene: {
                xaxis: {
                    title: {
                        text: 'Questões por Módulo',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                yaxis: {
                    title: {
                        text: 'Desempenho (%)',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                zaxis: {
                    title: {
                        text: 'Tempo por Questão (s)',
                        font: { color: textColor }
                    },
                    gridcolor: gridColor,
                    zerolinecolor: gridColor
                },
                bgcolor: bgColor,
                camera: {
                    eye: { x: 1.7, y: 1.7, z: 1.7 }
                }
            },
            paper_bgcolor: bgColor,
            plot_bgcolor: bgColor,
            font: { color: textColor },
            margin: { l: 0, r: 0, b: 0, t: 40 },
            showlegend: true,
            legend: {
                x: 0.1,
                y: 0.9,
                font: { color: textColor }
            }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['select2d', 'lasso2d']
        };

        // Renderizar ou atualizar gráfico
        Plotly.newPlot(container, [markerTrace, lineTrace], layout, config)
            .then(() => {
                document.getElementById('module3dError').classList.add('hidden');
                module3dChartInstance = container;
                fillModule3dTable(graphData);
            })
            .catch(error => {
                console.error('Erro ao renderizar gráfico 3D por módulo:', error);
                document.getElementById('module3dError').classList.remove('hidden');
            });
    }

    // Preencher tabela de métricas para gráfico por módulo
    function fillModule3dTable(data) {
        const tableBody = document.getElementById('module3dTable');
        if (!tableBody || data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-slate-500">Nenhum dado disponível</td></tr>';
            return;
        }

        // Ordenar por desempenho (do maior para o menor)
        const sortedData = [...data].sort((a, b) => b.avgPerformance - a.avgPerformance);
        
        let tableHTML = '';
        
        sortedData.forEach(item => {
            const moduleName = item.moduleName.length > 15 ? item.moduleName.substring(0, 15) + '...' : item.moduleName;
            
            // Determinar ícone de evolução
            let evolutionIcon = '';
            let evolutionClass = '';
            if (item.evolution > 1) {
                evolutionIcon = '<i class="fas fa-arrow-up text-green-500"></i>';
                evolutionClass = 'text-green-600 dark:text-green-400';
            } else if (item.evolution < -1) {
                evolutionIcon = '<i class="fas fa-arrow-down text-red-500"></i>';
                evolutionClass = 'text-red-600 dark:text-red-400';
            } else {
                evolutionIcon = '<i class="fas fa-minus text-slate-400"></i>';
                evolutionClass = 'text-slate-500';
            }

            tableHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td class="px-3 py-2" title="${item.moduleName}">${moduleName}</td>
                    <td class="px-3 py-2 font-bold">${item.avgQuestions.toFixed(1)}</td>
                    <td class="px-3 py-2 font-bold ${item.avgPerformance >= 70 ? 'text-green-600' : item.avgPerformance >= 50 ? 'text-yellow-600' : 'text-red-600'}">${item.avgPerformance.toFixed(1)}%</td>
                    <td class="px-3 py-2">${item.avgTime.toFixed(1)}s</td>
                    <td class="px-3 py-2">${item.totalSimulations}</td>
                    <td class="px-3 py-2 ${evolutionClass}">${evolutionIcon} ${item.evolution > 0 ? '+' : ''}${item.evolution.toFixed(1)}%</td>
                </tr>
            `;
        });

        tableBody.innerHTML = tableHTML;
    }

    // ============================================
    // NOVAS FUNÇÕES PARA INDICADORES DE EVOLUÇÃO
    // ============================================

    // Calcula a evolução do desempenho para diferentes períodos
    function calculateEvolution(historyData, days) {
        if (historyData.length === 0) return { evolution: 0, trend: 'Nenhum dado disponível' };
        
        const now = new Date();
        const recentStart = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
        const previousStart = new Date(now.getTime() - (days * 2 * 24 * 60 * 60 * 1000));
        const previousEnd = recentStart;
        
        // Filtrar dados para os períodos
        const recentData = historyData.filter(item => new Date(item.date) >= recentStart);
        const previousData = historyData.filter(item => 
            new Date(item.date) >= previousStart && new Date(item.date) < previousEnd
        );
        
        if (recentData.length === 0) return { evolution: 0, trend: 'Sem dados recentes' };
        
        // Calcular médias
        const recentAvg = recentData.reduce((sum, item) => sum + item.percent, 0) / recentData.length;
        
        let previousAvg = 0;
        let evolution = 0;
        let trend = '';
        
        if (previousData.length > 0) {
            previousAvg = previousData.reduce((sum, item) => sum + item.percent, 0) / previousData.length;
            evolution = recentAvg - previousAvg;
            
            if (evolution > 5) {
                trend = 'Em forte alta';
            } else if (evolution > 1) {
                trend = 'Em alta';
            } else if (evolution < -5) {
                trend = 'Em forte queda';
            } else if (evolution < -1) {
                trend = 'Em queda';
            } else {
                trend = 'Estável';
            }
        } else {
            evolution = 0;
            trend = 'Sem dados anteriores para comparar';
        }
        
        return {
            evolution: evolution,
            trend: trend,
            recentAvg: recentAvg,
            previousAvg: previousAvg
        };
    }

    // Atualiza métricas dos cards superiores
    function updateMetricsCards() {
        let h = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
        
        if (h.length === 0) {
            document.getElementById('avg-overall').textContent = '0%';
            document.getElementById('avg-time-per-q').textContent = '0s';
            document.getElementById('best-module').textContent = '-';
            document.getElementById('best-module-score').textContent = '0%';
            document.getElementById('worst-module').textContent = '-';
            document.getElementById('worst-module-score').textContent = '0%';
            
            // Limpar indicadores de evolução
            ['1d', '2d', '7d', '30d'].forEach(period => {
                document.getElementById(`evolution-${period}`).textContent = '0%';
                document.getElementById(`evolution-${period}-trend`).textContent = 'Nenhum dado disponível';
            });
            
            document.getElementById('avg-trend').textContent = 'Nenhum dado disponível';
            document.getElementById('time-trend').textContent = 'Nenhum dado disponível';
            return;
        }

        // Calcular média geral
        const avgOverall = h.length > 0 ? 
            h.reduce((sum, item) => sum + item.percent, 0) / h.length : 0;
        document.getElementById('avg-overall').textContent = `${avgOverall.toFixed(1)}%`;

        // Calcular tempo médio por questão
        const totalQuestions = h.reduce((sum, item) => sum + item.total, 0);
        const totalTime = h.reduce((sum, item) => sum + (item.duration || 0), 0);
        const avgTimePerQuestion = totalQuestions > 0 ? totalTime / totalQuestions : 0;
        document.getElementById('avg-time-per-q').textContent = `${avgTimePerQuestion.toFixed(1)}s`;

        // Encontrar melhor e pior módulo
        const modulePerformance = new Map();
        h.forEach(item => {
            Object.entries(item.modules || {}).forEach(([moduleName, moduleStats]) => {
                if (!modulePerformance.has(moduleName)) {
                    modulePerformance.set(moduleName, { correct: 0, total: 0, attempts: 0 });
                }
                const data = modulePerformance.get(moduleName);
                data.correct += moduleStats.correct;
                data.total += moduleStats.total;
                data.attempts += 1;
            });
        });

        let bestModule = '-';
        let bestModuleScore = 0;
        let worstModule = '-';
        let worstModuleScore = 100;
        
        modulePerformance.forEach((data, moduleName) => {
            if (data.total > 0) {
                const score = (data.correct / data.total) * 100;
                if (score > bestModuleScore) {
                    bestModuleScore = score;
                    bestModule = moduleName;
                }
                if (score < worstModuleScore && data.attempts >= 2) {
                    worstModuleScore = score;
                    worstModule = moduleName;
                }
            }
        });

        document.getElementById('best-module').textContent = bestModule.length > 20 ? 
            bestModule.substring(0, 20) + '...' : bestModule;
        document.getElementById('best-module-score').textContent = `${bestModuleScore.toFixed(1)}%`;
        
        document.getElementById('worst-module').textContent = worstModule.length > 20 ? 
            worstModule.substring(0, 20) + '...' : worstModule;
        document.getElementById('worst-module-score').textContent = worstModule !== '-' ? `${worstModuleScore.toFixed(1)}%` : 'N/A';

        // Calcular evoluções para diferentes períodos
        const periods = [1, 2, 7, 30];
        periods.forEach(days => {
            const evolutionData = calculateEvolution(h, days);
            const evolutionElement = document.getElementById(`evolution-${days}d`);
            const trendElement = document.getElementById(`evolution-${days}d-trend`);
            
            if (evolutionElement && trendElement) {
                evolutionElement.textContent = `${evolutionData.evolution > 0 ? '+' : ''}${evolutionData.evolution.toFixed(1)}%`;
                
                // Aplicar classe CSS baseada na evolução
                if (evolutionData.evolution > 1) {
                    evolutionElement.classList.remove('text-red-600', 'text-slate-600');
                    evolutionElement.classList.add('text-green-600');
                } else if (evolutionData.evolution < -1) {
                    evolutionElement.classList.remove('text-green-600', 'text-slate-600');
                    evolutionElement.classList.add('text-red-600');
                } else {
                    evolutionElement.classList.remove('text-green-600', 'text-red-600');
                    evolutionElement.classList.add('text-slate-600');
                }
                
                trendElement.textContent = evolutionData.trend;
            }
        });
        
        // Determinar tendências gerais
        const avgTrendText = avgOverall >= 70 ? 'Excelente!' : avgOverall >= 50 ? 'Bom, pode melhorar' : 'Precisa melhorar';
        document.getElementById('avg-trend').textContent = avgTrendText;
        
        const timeTrendText = avgTimePerQuestion < 60 ? 'Ótimo ritmo!' : avgTimePerQuestion < 120 ? 'Ritmo adequado' : 'Muito lento';
        document.getElementById('time-trend').textContent = timeTrendText;
    }

    // ============================================
    // FUNÇÕES MODIFICADAS PARA USAR PLOTLY.JS
    // ============================================

    // Atualiza ambos os gráficos 3D
    function update3dCharts() {
        let h = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
        
        // Aplicar filtros
        if(analytics3dFilters.days !== 'all') { 
            const limit = new Date(); 
            limit.setDate(limit.getDate() - analytics3dFilters.days); 
            h = h.filter(x => new Date(x.date) >= limit); 
        }

        if(analytics3dFilters.module !== 'all') {
            h = h.filter(item => item.modules && item.modules[analytics3dFilters.module]);
        }

        // Atualizar contador de histórico
        document.getElementById('history-count').textContent = `${h.length} ${h.length === 1 ? 'registro' : 'registros'}`;

        // Renderizar gráficos 3D com Plotly.js
        renderOverall3dChart(h);
        renderModule3dChart(h);
        
        // Atualizar métricas dos cards
        updateMetricsCards();
    }

    // ============================================
    // NOVAS FUNÇÕES PARA GRÁFICO DE PIZZA
    // ============================================

    function renderPieChart(historyData) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        
        if (pieChartInstance) {
            pieChartInstance.destroy();
        }
        
        if (historyData.length === 0) {
            pieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sem dados'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#94a3b8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Nenhum dado disponível';
                                }
                            }
                        }
                    }
                }
            });
            return;
        }

        // Coletar dados por módulo
        const moduleData = new Map();
        historyData.forEach(item => {
            Object.entries(item.modules || {}).forEach(([moduleName, moduleStats]) => {
                if (!moduleData.has(moduleName)) {
                    moduleData.set(moduleName, { correct: 0, total: 0 });
                }
                const data = moduleData.get(moduleName);
                data.correct += moduleStats.correct;
                data.total += moduleStats.total;
            });
        });

        // Preparar dados para o gráfico de pizza
        const modules = Array.from(moduleData.keys());
        const correctAnswers = modules.map(module => moduleData.get(module).correct);
        const totalAnswers = modules.map(module => moduleData.get(module).total);
        
        // Calcular porcentagens CORRETAMENTE - baseado no total de questões respondidas por módulo
        const percentages = modules.map((module, index) => {
            const total = totalAnswers[index];
            return total > 0 ? (correctAnswers[index] / total) * 100 : 0;
        });

        // Limitar a 10 módulos para o gráfico não ficar muito poluído
        const maxModules = 10;
        let displayModules = modules;
        let displayPercentages = percentages;
        
        if (modules.length > maxModules) {
            // Combinar módulos menores em "Outros"
            const moduleStats = modules.map((module, index) => ({
                module,
                percentage: percentages[index],
                total: totalAnswers[index]
            }));
            
            moduleStats.sort((a, b) => b.total - a.total);
            
            const topModules = moduleStats.slice(0, maxModules - 1);
            const otherModules = moduleStats.slice(maxModules - 1);
            
            const otherPercentage = otherModules.reduce((sum, item) => sum + item.total, 0) > 0 ?
                (otherModules.reduce((sum, item) => sum + item.correct, 0) / otherModules.reduce((sum, item) => sum + item.total, 0)) * 100 : 0;
            const otherTotal = otherModules.reduce((sum, item) => sum + item.total, 0);
            
            displayModules = [...topModules.map(item => item.module), 'Outros'];
            displayPercentages = [...topModules.map(item => item.percentage), otherPercentage];
        }

        // Gerar cores dinamicamente
        const generateColors = (count) => {
            const colors = [];
            const hueStep = 360 / count;
            for (let i = 0; i < count; i++) {
                const hue = i * hueStep;
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            return colors;
        };

        pieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: displayModules,
                datasets: [{
                    data: displayPercentages,
                    backgroundColor: generateColors(displayModules.length),
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const moduleName = label;
                                const moduleInfo = moduleData.get(moduleName);
                                
                                if (moduleName === 'Outros') {
                                    const otherTotal = moduleData.get('Outros') ? moduleData.get('Outros').total : 
                                        modules.slice(maxModules - 1).reduce((sum, mod) => sum + moduleData.get(mod).total, 0);
                                    const otherCorrect = moduleData.get('Outros') ? moduleData.get('Outros').correct :
                                        modules.slice(maxModules - 1).reduce((sum, mod) => sum + moduleData.get(mod).correct, 0);
                                    return `${label}: ${value.toFixed(1)}% (${otherCorrect}/${otherTotal})`;
                                }
                                
                                if (moduleInfo) {
                                    return `${label}: ${value.toFixed(1)}% (${moduleInfo.correct}/${moduleInfo.total})`;
                                }
                                return `${label}: ${value.toFixed(1)}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ============================================
    // FUNÇÕES MODIFICADAS PARA CORRIGIR FILTRO DE MÓDULOS
    // ============================================

    // Obtém módulos únicos do histórico (somente módulos com questões respondidas)
    function getUniqueModulesFromHistory(historyData) {
        const modules = new Set();
        historyData.forEach(item => {
            Object.keys(item.modules || {}).forEach(mod => modules.add(mod));
        });
        return Array.from(modules).sort();
    }

    // Atualiza o select de filtro de módulos com base no histórico
    function updateModuleFilterSelect(modules, selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const currentValue = select.value;
        select.innerHTML = '<option value="all">Todos os módulos</option>';
        
        modules.forEach(mod => {
            const option = document.createElement('option');
            option.value = mod;
            option.textContent = mod;
            select.appendChild(option);
        });
        
        // Restaurar valor selecionado se ainda estiver disponível
        if (currentValue && modules.includes(currentValue)) {
            select.value = currentValue;
        } else {
            select.value = 'all';
        }
    }

    // ============================================
    // FUNÇÕES EXISTENTES MODIFICADAS
    // ============================================

    async function loadDatabase() {
        try {
            showLoadingState(true);
            
            const cachedData = localStorage.getItem('alerr_fullDatabase');
            const cacheTimestamp = localStorage.getItem('alerr_cacheTimestamp');
            const oneDay = 24 * 60 * 60 * 1000;
            
            if (cachedData && cacheTimestamp && (Date.now() - parseInt(cacheTimestamp)) < oneDay) {
                const parsedData = JSON.parse(cachedData);
                fullDatabase = parsedData.database;
                appState.moduleCounts = parsedData.moduleCounts;
                appState.moduleCounts2018 = parsedData.moduleCounts2018;
                
                console.log("Dados carregados do cache");
                renderModules();
                updateDistribution();
                showLoadingState(false);
                
                // Verifica se há simulado pausado
                const paused = localStorage.getItem('alerr_paused_sim');
                if (paused) {
                    document.getElementById('paused-alert').classList.remove('hidden');
                }
                
                showScreen('home');
                return;
            }
            
            const promises = DB_FILES.map(file => 
                fetch(file)
                    .then(res => {
                        if (!res.ok) throw new Error(`Erro ao carregar ${file}: ${res.status}`);
                        return res.json().then(data => ({ data, file }));
                    })
                    .catch(error => {
                        console.error(`Erro ao carregar ${file}:`, error);
                        return { data: [], file, error: true };
                    })
            );
            
            const results = await Promise.all(promises);
            let allQs = [];
            
            results.forEach(item => {
                if (item.error) return;
                
                const is2018File = item.file.includes('2018');
                const qs = item.data.map((q, i) => normalizeQuestion(q, i, is2018File));
                allQs = allQs.concat(qs);
            });
            
            fullDatabase = allQs;
            
            fullDatabase.forEach(q => {
                appState.moduleCounts[q.module] = (appState.moduleCounts[q.module] || 0) + 1;
                if(q.is2018) appState.moduleCounts2018[q.module] = (appState.moduleCounts2018[q.module] || 0) + 1;
            });
            
            availableModules = [...new Set(fullDatabase.map(q => q.module))].sort();
            
            const cacheData = {
                database: fullDatabase,
                moduleCounts: appState.moduleCounts,
                moduleCounts2018: appState.moduleCounts2018
            };
            localStorage.setItem('alerr_fullDatabase', JSON.stringify(cacheData));
            localStorage.setItem('alerr_cacheTimestamp', Date.now().toString());
            
            renderModules();
            updateDistribution();
            showLoadingState(false);
            
            // Verifica se há simulado pausado
            const paused = localStorage.getItem('alerr_paused_sim');
            if (paused) {
                document.getElementById('paused-alert').classList.remove('hidden');
            }
            
            showScreen('home');
            
        } catch (error) {
            console.error("Erro ao carregar banco de dados:", error);
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-error').classList.remove('hidden');
            showLoadingState(false);
        }
    }

    function showLoadingState(show) {
        const moduleContainer = document.getElementById('module-container');
        if (show) {
            moduleContainer.innerHTML = '<div class="p-8 text-center text-slate-400"><div class="loader mx-auto mb-2"></div> Carregando módulos...</div>';
        }
    }

    function normalizeQuestion(q, id, from2018File) {
        let mod = q.titulo || "Geral";
        const match = mod.match(/Título\s+([IVXLCDM]+)/i);
        if(match) {
            const rest = mod.split('-').pop().trim();
            mod = `Título ${match[1].toUpperCase()} - ${rest}`;
        } else {
             mod = mod.replace('Regimento Interno 2023 - ', '').trim();
        }
        if(from2018File) mod = "Questões de Concursos Anteriores (2018)";
        
        let correctIdx = 0;
        if(q.resposta) {
            correctIdx = ['A','B','C','D','E'].indexOf(q.resposta.toUpperCase());
            if(correctIdx === -1) correctIdx = 0;
        }
        
        let options = [];
        if (Array.isArray(q.alternativas)) {
            options = q.alternativas;
        } else if (typeof q.alternativas === 'object' && q.alternativas !== null) {
            options = Object.values(q.alternativas);
        } else {
            options = ["Alternativa não disponível"];
        }
        
        return {
            id: id,
            module: mod,
            text: q.enunciado || q.question || "Questão sem enunciado",
            options: options,
            correct: correctIdx,
            explanation: q.explicacao || q.explanation || "Sem comentário disponível.",
            is2018: from2018File || (q.source === '2018') || (q.titulo && q.titulo.includes('2018'))
        };
    }

    function renderModules() {
        const modules = Object.keys(appState.moduleCounts).sort();
        const container = document.getElementById('module-container');
        container.innerHTML = '';
        
        modules.forEach(mod => {
            const count = appState.moduleCounts[mod];
            const is2018Module = mod.includes('2018');
            const label = document.createElement('label');
            label.className = "flex items-center justify-between p-2 hover:bg-slate-100 dark:hover:bg-slate-700/50 rounded transition group border-b border-transparent hover:border-slate-200 dark:hover:border-slate-600 cursor-pointer module-row";
            label.setAttribute('data-module', mod);
            label.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden flex-grow">
                    <input type="checkbox" value="${mod}" class="mod-chk w-4 h-4 text-brand-600 rounded focus:ring-brand-500 cursor-pointer transition" onchange="updateDistribution()" ${is2018Module ? 'data-2018="true"' : ''}>
                    <span class="text-xs md:text-sm truncate select-none dark:text-slate-300 font-medium" title="${mod}">${mod}</span>
                </div>
                <div class="flex items-center gap-3">
                    <input type="number" min="0" max="${count}" class="manual-input hidden w-14 h-7 text-xs border border-slate-300 rounded px-1 text-center focus:border-brand-500 outline-none dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="0" oninput="updateDistribution()">
                    <span class="text-[10px] font-bold bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded-full min-w-[24px] text-center">${count}</span>
                </div>
            `;
            container.appendChild(label);
        });
        
        updateBadges();
    }

    function updateBadges() {
        const checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked'));
        document.getElementById('badge-modules').innerText = checkedModules.length;
        document.getElementById('badge-total').innerText = fullDatabase.length;
        
        // Atualizar questões disponíveis
        const is2018 = document.getElementById('filter-2018').checked;
        let availableCount = 0;
        
        if (is2018) {
            availableCount = fullDatabase.filter(q => q.is2018).length;
        } else {
            const checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            availableCount = fullDatabase.filter(q => checkedModules.includes(q.module)).length;
        }
        
        document.getElementById('badge-available').innerText = availableCount;
    }

    function toggle2018Lock() {
        const isLocked = document.getElementById('filter-2018').checked;
        const moduleRows = document.querySelectorAll('.module-row');
        
        moduleRows.forEach(row => {
            const modName = row.getAttribute('data-module');
            const checkbox = row.querySelector('.mod-chk');
            const is2018Module = modName.includes('2018');
            
            if (isLocked) {
                if (is2018Module) {
                    checkbox.checked = true;
                    checkbox.disabled = false;
                    row.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    row.classList.add('opacity-50', 'pointer-events-none');
                }
            } else {
                if (is2018Module) {
                    checkbox.checked = false;
                }
                checkbox.disabled = false;
                row.classList.remove('opacity-50', 'pointer-events-none');
            }
        });
        
        updateBadges();
        updateDistribution();
    }

    function toggleAllModules(val) {
        if(document.getElementById('filter-2018').checked) return;
        
        document.querySelectorAll('.mod-chk').forEach(c => {
            if (!c.disabled) {
                c.checked = val;
            }
        });
        
        updateBadges();
        updateDistribution();
    }

    function handleModeChange() {
        const mode = document.getElementById('distribution-mode').value;
        const qtyContainer = document.getElementById('qty-selector-container');
        
        if(mode === 'manual') {
            document.querySelectorAll('.manual-input').forEach(el => el.classList.remove('hidden'));
            qtyContainer.classList.add('opacity-50', 'pointer-events-none');
        } else {
            document.querySelectorAll('.manual-input').forEach(el => el.classList.add('hidden'));
            qtyContainer.classList.remove('opacity-50', 'pointer-events-none');
        }
        
        updateDistribution();
    }

    function setQuantity(val, evt) {
        document.querySelectorAll('.btn-qty').forEach(b => {
            b.classList.remove('bg-brand-50','border-brand-500','text-brand-700','dark:bg-brand-900/30','dark:text-brand-300');
            b.classList.add('border-slate-200','dark:border-slate-600');
        });
        
        if(val === 'custom') {
            const v = document.getElementById('custom-qty').value;
            appState.config.qty = parseInt(v) || 0;
        } else if(val === 'all') {
            appState.config.qty = 'all';
            if (evt) {
                evt.target.classList.add('bg-purple-50','border-purple-200','text-purple-700');
            }
        } else {
            appState.config.qty = val;
            document.getElementById('custom-qty').value = '';
            const btn = document.querySelector(`.btn-qty[data-val="${val}"]`);
            if(btn) btn.classList.add('bg-brand-50','border-brand-500','text-brand-700','dark:bg-brand-900/30','dark:text-brand-300');
        }
        
        updateDistribution();
    }

    function updateDistribution() {
        const is2018 = document.getElementById('filter-2018').checked;
        const mode = document.getElementById('distribution-mode').value;
        
        let availablePool = [];
        let checkedModules = [];
        
        if (is2018) {
            availablePool = fullDatabase.filter(q => q.is2018);
            checkedModules = ["Questões de Concursos Anteriores (2018)"];
        } else {
            checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            availablePool = fullDatabase.filter(q => checkedModules.includes(q.module));
        }

        document.getElementById('badge-modules').innerText = checkedModules.length;
        document.getElementById('badge-available').innerText = availablePool.length;

        appState.distribution = {};
        let totalPlan = 0;

        if (mode === 'manual') {
            document.querySelectorAll('.mod-chk:checked').forEach(cb => {
                const row = cb.closest('label');
                const input = row.querySelector('.manual-input');
                let val = parseInt(input.value) || 0;
                const realAvailable = fullDatabase.filter(q => q.module === cb.value && (!is2018 || q.is2018)).length;
                if(val > realAvailable) val = realAvailable;
                if(val > 0) {
                    appState.distribution[cb.value] = val;
                    totalPlan += val;
                }
            });
        } else {
            let targetQty = appState.config.qty === 'all' ? availablePool.length : appState.config.qty;
            if(targetQty > availablePool.length) targetQty = availablePool.length;
            totalPlan = targetQty;
            
            if(targetQty > 0 && availablePool.length > 0) {
                const moduleWeights = {};
                checkedModules.forEach(mod => {
                    moduleWeights[mod] = availablePool.filter(q => q.module === mod).length;
                });
                
                const totalWeight = Object.values(moduleWeights).reduce((a, b) => a + b, 0);
                
                if (mode === 'proportional' && totalWeight > 0) {
                    let remaining = targetQty;
                    Object.keys(moduleWeights).forEach(mod => {
                        const count = Math.round(moduleWeights[mod] / totalWeight * targetQty);
                        appState.distribution[mod] = Math.min(count, moduleWeights[mod]);
                        remaining -= appState.distribution[mod];
                    });
                    
                    if (remaining !== 0) {
                        const modules = Object.keys(moduleWeights);
                        for (let i = 0; i < Math.abs(remaining) && modules.length > 0; i++) {
                            const mod = modules[i % modules.length];
                            if (remaining > 0 && appState.distribution[mod] < moduleWeights[mod]) {
                                appState.distribution[mod]++;
                                remaining--;
                            } else if (remaining < 0 && appState.distribution[mod] > 0) {
                                appState.distribution[mod]--;
                                remaining++;
                            }
                        }
                    }
                } else if (mode === 'balanced') {
                    const modules = checkedModules.filter(mod => moduleWeights[mod] > 0);
                    const baseCount = Math.floor(targetQty / modules.length);
                    let remainder = targetQty % modules.length;
                    
                    modules.forEach(mod => {
                        let count = baseCount;
                        if (remainder > 0 && moduleWeights[mod] >= baseCount + 1) {
                            count++;
                            remainder--;
                        }
                        appState.distribution[mod] = Math.min(count, moduleWeights[mod]);
                    });
                    
                    if (remainder > 0) {
                        for (let mod of modules) {
                            if (remainder <= 0) break;
                            if (appState.distribution[mod] < moduleWeights[mod]) {
                                appState.distribution[mod]++;
                                remainder--;
                            }
                        }
                    }
                }
            }
        }

        document.getElementById('badge-target').innerText = totalPlan;

        const previewList = document.getElementById('distribution-preview');
        previewList.innerHTML = '';
        
        if (availablePool.length === 0) {
            previewList.innerHTML = `<p class="text-slate-400 italic">Nenhuma questão disponível.</p>`;
            document.getElementById('preview-total').innerText = "0 questões";
        } else {
             if(mode === 'manual') {
                let displayTotal = 0;
                for (const [mod, qtd] of Object.entries(appState.distribution)) {
                    displayTotal += qtd;
                    previewList.innerHTML += `<div class="flex justify-between border-b border-slate-100 dark:border-slate-600 pb-1"><span class="truncate pr-2">${mod}</span><span class="font-bold text-brand-600">${qtd}</span></div>`;
                }
                document.getElementById('preview-total').innerText = `${displayTotal} questões`;
             } else {
                 if (mode === 'random') {
                     document.getElementById('preview-total').innerText = `${totalPlan} questões (Sorteio Aleatório)`;
                     previewList.innerHTML = `<p class="text-brand-600 font-bold">Serão sorteadas ${totalPlan} questões do universo de ${availablePool.length} disponíveis.</p>`;
                 } else {
                     let previewHTML = `<p class="text-brand-600 font-bold">Distribuição planejada (${totalPlan} questões):</p>`;
                     for (const [mod, qtd] of Object.entries(appState.distribution)) {
                         previewHTML += `<div class="flex justify-between border-b border-slate-100 dark:border-slate-600 pb-1 mt-1"><span class="truncate pr-2">${mod}</span><span class="font-bold text-brand-600">${qtd}</span></div>`;
                     }
                     previewList.innerHTML = previewHTML;
                 }
             }
        }
    }

    function startSimulation() {
        const mode = document.getElementById('distribution-mode').value;
        const is2018 = document.getElementById('filter-2018').checked;
        
        let checkedModules = [];
        let pool = [];
        
        if (is2018) {
            pool = fullDatabase.filter(q => q.is2018);
            checkedModules = ["Questões de Concursos Anteriores (2018)"];
        } else {
            checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            if(checkedModules.length === 0) {
                alert("Selecione pelo menos um módulo.");
                return;
            }
            pool = fullDatabase.filter(q => checkedModules.includes(q.module));
        }

        let reqQty = 0;
        if(mode === 'manual') {
             for(let k in appState.distribution) reqQty += appState.distribution[k];
        } else {
             reqQty = appState.config.qty === 'all' ? pool.length : appState.config.qty;
        }

        if(pool.length === 0) {
            alert("Sem questões disponíveis para os critérios selecionados.");
            return;
        }
        
        if(reqQty > pool.length && mode !== 'manual') {
            document.getElementById('warning-modal').classList.remove('hidden');
            return;
        }

        let finalQuestions = [];
        
        if (mode === 'manual') {
            for (const [mod, qtd] of Object.entries(appState.distribution)) {
                const modPool = pool.filter(q => q.module === mod);
                const shuffled = [...modPool].sort(() => Math.random() - 0.5);
                finalQuestions.push(...shuffled.slice(0, qtd));
            }
        } else {
            if(mode === 'random') {
                const shuffled = [...pool].sort(() => Math.random() - 0.5);
                finalQuestions = shuffled.slice(0, reqQty);
            } else if (mode === 'balanced' || mode === 'proportional') {
                for (const [mod, qtd] of Object.entries(appState.distribution)) {
                    const modPool = pool.filter(q => q.module === mod);
                    const shuffled = [...modPool].sort(() => Math.random() - 0.5);
                    finalQuestions.push(...shuffled.slice(0, qtd));
                }
            }
        }

        finalQuestions = finalQuestions.sort(() => Math.random() - 0.5);
        
        if(finalQuestions.length === 0) {
            alert("Erro na geração do simulado. Nenhuma questão foi selecionada.");
            return;
        }
        
        appState.questions = finalQuestions;
        appState.answers = new Array(finalQuestions.length).fill(null).map(() => ({ sel: null, ok: false, isCorrect: false }));
        appState.index = 0;
        appState.startTime = new Date();
        appState.isPaused = false;
        
        startTimer();
        loadQuestion(0);
        renderNav();
        showScreen('quiz');
    }

    function toggleCacheModal() {
        const m = document.getElementById('cache-modal');
        m.classList.toggle('hidden');
        updateCacheStats();
    }
    
    function updateCacheStats() {
        let used = 0;
        for(let x in localStorage) { 
            if(localStorage.hasOwnProperty(x)) {
                used += (localStorage[x].length + x.length) * 2; 
            }
        }
        const kb = (used / 1024).toFixed(2);
        document.getElementById('cache-usage-text').innerText = `${kb} KB`;
        
        const footerBadge = document.getElementById('footer-cache-stat');
        if (footerBadge) footerBadge.innerText = `${kb} KB`;

        const percent = Math.min((used/5000000)*100, 100);
        document.getElementById('cache-bar').style.width = `${percent}%`;
    }
    
    function toggleHistorySaving() {
        appState.savingEnabled = document.getElementById('toggle-save-history').checked;
        localStorage.setItem('alerr_save_pref', appState.savingEnabled);
        updateCacheStats();
    }
    
    function clearHistory(scope) {
        if(!confirm("Tem certeza que deseja limpar o histórico?")) return;
        
        let h = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
        const now = new Date().getTime();
        let cutoff = 0;

        if(scope === 'all') { 
            localStorage.removeItem('alerr_hist'); 
            localStorage.removeItem('alerr_fullDatabase');
            localStorage.removeItem('alerr_cacheTimestamp');
            loadHistory(); 
            updateCacheStats(); 
            toggleCacheModal();
            return; 
        }
        
        if(scope === '1h') cutoff = now - (1 * 60 * 60 * 1000);
        else if(scope === '2h') cutoff = now - (2 * 60 * 60 * 1000);
        else if(scope === '4h') cutoff = now - (4 * 60 * 60 * 1000);
        else if(scope === '24h') cutoff = now - (24 * 60 * 60 * 1000);
        else if(scope === 'week') cutoff = now - (7 * 24 * 60 * 60 * 1000);
        else if(scope === 'month') cutoff = now - (30 * 24 * 60 * 60 * 1000);
        else if(scope === 'custom') {
            const dateVal = document.getElementById('custom-date-clear').value;
            if(!dateVal) return alert("Selecione uma data.");
            cutoff = new Date(dateVal).getTime();
        }

        h = h.filter(x => new Date(x.date).getTime() >= cutoff);
        localStorage.setItem('alerr_hist', JSON.stringify(h));
        loadHistory(); 
        updateCacheStats();
        toggleCacheModal();
    }

    function loadQuestion(idx) {
        if (idx < 0 || idx >= appState.questions.length) return;
        
        appState.index = idx;
        const q = appState.questions[idx];
        const ans = appState.answers[idx];
        
        document.getElementById('q-current-index').innerText = idx + 1;
        document.getElementById('q-total-count').innerText = appState.questions.length;
        document.getElementById('q-module-name').innerText = q.module;
        document.getElementById('q-text').innerText = q.text;
        document.getElementById('progress-bar').style.width = `${((idx+1)/appState.questions.length)*100}%`;
        
        const divOpts = document.getElementById('options-container');
        divOpts.innerHTML = '';
        
        const letters = ['A','B','C','D','E'];
        q.options.forEach((opt, i) => {
            const el = document.createElement('div');
            let cls = "option-card w-full p-4 rounded-xl flex items-start cursor-pointer border-2 bg-white dark:bg-slate-700 border-slate-100 dark:border-slate-600";
            
            if(ans.ok) {
                el.classList.add('cursor-default','disabled');
                if(i === q.correct) {
                    cls += " correct";
                } else if(i === ans.sel) {
                    cls += " wrong";
                } else {
                    cls += " opacity-40";
                }
            } else {
                if(ans.sel === i) cls += " selected"; 
                el.onclick = () => selectOpt(i);
            }
            
            el.className = cls;
            el.innerHTML = `
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold mr-4 shrink-0 transition ${
                    ans.sel === i ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300 text-slate-400'
                }">${letters[i]}</div>
                <div class="text-slate-700 dark:text-slate-200 pt-1 text-sm md:text-base">${opt}</div>
            `;
            divOpts.appendChild(el);
        });
        
        const btnConf = document.getElementById('btn-confirm');
        const boxExp = document.getElementById('explanation-box');
        
        if(ans.ok) { 
            btnConf.classList.add('hidden'); 
            boxExp.classList.remove('hidden'); 
            document.getElementById('explanation-text').innerText = q.explanation; 
        } else { 
            btnConf.classList.remove('hidden'); 
            btnConf.disabled = (ans.sel === null); 
            boxExp.classList.add('hidden'); 
        }
        
        const btnNext = document.getElementById('btn-next');
        if(idx === appState.questions.length - 1) { 
            btnNext.innerText = "Finalizar"; 
            btnNext.className = "bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full";
            btnNext.onclick = finishSimulation; 
        } else { 
            btnNext.onclick = () => changeQuestion(1); 

            if(ans.ok) {
                btnNext.innerHTML = 'Próxima <i class="fas fa-arrow-right ml-2"></i>';
                btnNext.className = "bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold transition mobile-full shadow-md";
            } else {
                btnNext.innerText = "Pular";
                btnNext.className = "bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full";
            }
        }
        
        document.getElementById('btn-prev').disabled = idx === 0;
        document.querySelectorAll('.nav-dot').forEach((d, i) => {
            d.classList.toggle('ring-2', i === idx);
            d.classList.toggle('ring-brand-500', i === idx);
        });
    }
    
    function selectOpt(i) { 
        appState.answers[appState.index].sel = i; 
        loadQuestion(appState.index); 
    }
    
    function confirmAnswer() {
        const idx = appState.index; 
        if(appState.answers[idx].sel === null) return;
        
        const isCorrect = (appState.answers[idx].sel === appState.questions[idx].correct);
        appState.answers[idx].ok = true; 
        appState.answers[idx].isCorrect = isCorrect;
        
        loadQuestion(idx); 
        renderNav();
    }
    
    function changeQuestion(d) { 
        const n = appState.index + d; 
        if(n >= 0 && n < appState.questions.length) loadQuestion(n); 
    }
    
    function renderNav() {
        const g = document.getElementById('nav-grid'); 
        g.innerHTML = '';
        
        appState.answers.forEach((a, i) => {
            const d = document.createElement('div');
            let cls = "nav-dot w-full aspect-square rounded flex items-center justify-center text-xs font-bold cursor-pointer transition ";
            
            if(a.ok) {
                cls += a.isCorrect ? "bg-green-500 text-white" : "bg-red-500 text-white";
            } else {
                cls += "bg-slate-200 dark:bg-slate-600 text-slate-500";
            }
            
            if(i === appState.index) {
                cls += " ring-2 ring-brand-500 ring-offset-2 dark:ring-offset-slate-800";
            }
            
            d.className = cls; 
            d.innerText = i + 1; 
            d.onclick = () => loadQuestion(i); 
            g.appendChild(d);
        });
    }
    
    function startTimer() {
        appState.startTime = new Date();
        if(appState.timer) clearInterval(appState.timer);
        
        appState.timer = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - appState.startTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${minutes}:${seconds}`;
        }, 1000);
    }
    
    function calculateModuleStats() {
        const moduleStats = {};
        appState.questions.forEach((q, idx) => {
            const mod = q.module;
            if (!moduleStats[mod]) {
                moduleStats[mod] = { correct: 0, wrong: 0, unanswered: 0, total: 0 };
            }
            moduleStats[mod].total++;
            const ans = appState.answers[idx];
            if (!ans.ok) {
                moduleStats[mod].unanswered++;
            } else if (ans.isCorrect) {
                moduleStats[mod].correct++;
            } else {
                moduleStats[mod].wrong++;
            }
        });
        return moduleStats;
    }
    
    function finishSimulation() {
        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }
        
        let correct = 0, wrong = 0, unanswered = 0;
        appState.answers.forEach((a, i) => { 
            if(!a.ok) {
                unanswered++; 
            } else if(a.isCorrect) {
                correct++; 
            } else {
                wrong++; 
            }
        });
        
        const total = appState.questions.length; 
        const percent = total > 0 ? Math.round((correct/total)*100) : 0;
        const moduleStats = calculateModuleStats();
        const duration = appState.startTime ? Math.floor((new Date() - appState.startTime) / 1000) : 0;
        
        document.getElementById('res-correct').innerText = correct; 
        document.getElementById('res-wrong').innerText = wrong;
        document.getElementById('res-unanswered').innerText = unanswered; 
        document.getElementById('res-percent').innerText = `${percent}%`;
        
        const ctx = document.getElementById('resultChart').getContext('2d'); 
        if(resultChartInstance) resultChartInstance.destroy();
        
        resultChartInstance = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: ['Acertos','Erros','Branco'], 
                datasets: [{
                    data: [correct, wrong, unanswered], 
                    backgroundColor: ['#16a34a', '#dc2626', '#94a3b8'], 
                    borderWidth: 0
                }] 
            }, 
            options: { 
                cutout: '75%', 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false } 
                } 
            } 
        });
        
        if(appState.savingEnabled) {
            saveHistory({ 
                date: new Date(), 
                correct: correct, 
                wrong: wrong, 
                unanswered: unanswered,
                total: total,
                percent: percent,
                duration: duration,
                modules: moduleStats
            }); 
        }
        
        // Remove qualquer simulado pausado
        localStorage.removeItem('alerr_paused_sim');
        
        showScreen('result');
    }
    
    function saveHistory(data) { 
        const h = JSON.parse(localStorage.getItem('alerr_hist') || '[]'); 
        data.correct = Number(data.correct) || 0;
        data.wrong = Number(data.wrong) || 0;
        data.unanswered = Number(data.unanswered) || 0;
        data.total = Number(data.total) || 0;
        data.percent = Number(data.percent) || 0;
        data.duration = Number(data.duration) || 0;
        data.modules = data.modules || {};
        
        h.unshift(data); 
        if (h.length > 100) h.length = 100;
        localStorage.setItem('alerr_hist', JSON.stringify(h)); 
        updateCacheStats();
    }
    
    function setHistoryFilter(type, value) {
        historyFilters[type] = value;
        applyHistoryFilters();
        updateFilterButtons();
    }

    function set3dFilter(type, value) {
        analytics3dFilters[type] = value;
        update3dCharts();
        update3dFilterButtons();
    }
    
    function applyHistoryFilters() {
        loadHistory(historyFilters);
    }
    
    function updateFilterButtons() {
        const days = historyFilters.days;
        ['all','1','2','7','30'].forEach(f => { 
            const btn = document.getElementById(`hist-filter-${f}`);
            if (btn) {
                if (f == days) {
                    btn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700";
                } else {
                    btn.className = "px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700";
                }
            }
        });
    }

    function update3dFilterButtons() {
        const days = analytics3dFilters.days;
        ['all','1','7','30'].forEach(f => { 
            const btn = document.getElementById(`3d-filter-${f}`);
            if (btn) {
                if (f == days) {
                    btn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700";
                } else {
                    btn.className = "px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700";
                }
            }
        });
    }
    
    function loadHistory(filters = { days: 'all', module: 'all' }) {
        let h = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
        
        // Aplicar filtro de dias
        if(filters.days !== 'all') { 
            const limit = new Date(); 
            limit.setDate(limit.getDate() - filters.days); 
            h = h.filter(x => new Date(x.date) >= limit); 
        }

        // Obter módulos únicos do histórico filtrado
        const uniqueModules = getUniqueModulesFromHistory(h);
        
        // Atualizar o select de filtro de módulos com base no histórico
        updateModuleFilterSelect(uniqueModules, 'module-filter');
        updateModuleFilterSelect(uniqueModules, '3d-module-filter');

        // Aplicar filtro de módulo
        if(filters.module !== 'all') {
            h = h.filter(item => item.modules && item.modules[filters.module]);
        }

        // Tabela 1: Histórico Completo
        const tbody = document.getElementById('history-body'); 
        tbody.innerHTML = '';
        
        if(h.length === 0) {
            document.getElementById('no-history').classList.remove('hidden');
        } else {
            document.getElementById('no-history').classList.add('hidden');
            h.forEach(x => {
                const moduleNames = Object.keys(x.modules || {});
                const moduleDisplay = moduleNames.length === 0 ? 'Sem módulo' : 
                                    moduleNames.length === 1 ? moduleNames[0] : 
                                    'Vários módulos';
                
                const avgTime = x.total > 0 ? (x.duration || 0) / x.total : 0;
                
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                        <td class="px-6 py-4">${new Date(x.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 text-xs text-slate-500" title="${moduleNames.join(', ')}">
                            ${moduleDisplay.length > 30 ? moduleDisplay.substring(0, 30) + '...' : moduleDisplay}
                        </td>
                        <td class="px-6 py-4 text-green-600 font-bold">${x.correct}</td>
                        <td class="px-6 py-4 text-red-600 font-bold">${x.wrong}</td>
                        <td class="px-6 py-4 text-slate-500 font-bold">${x.unanswered}</td>
                        <td class="px-6 py-4 text-slate-600 font-mono">${avgTime.toFixed(1)}s</td>
                        <td class="px-6 py-4 text-right font-bold ${x.percent >= 70 ? 'text-green-600' : x.percent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${x.percent}%</td>
                    </tr>
                `;
            });
        }

        // Tabela 2: Detalhada por Módulo
        const moduleDetailBody = document.getElementById('module-detail-body');
        moduleDetailBody.innerHTML = '';
        
        // Atualizar descrição
        const description = document.getElementById('module-detail-description');
        if (filters.module === 'all') {
            description.textContent = 'Mostrando todos os módulos (selecione um módulo específico para detalhes)';
            document.getElementById('no-module-detail').classList.remove('hidden');
        } else {
            description.textContent = `Mostrando apenas o módulo: ${filters.module}`;
            document.getElementById('no-module-detail').classList.add('hidden');
            
            // Coletar todos os dados do módulo selecionado
            let moduleDetails = [];
            
            h.forEach(item => {
                if (item.modules && item.modules[filters.module]) {
                    const modData = item.modules[filters.module];
                    const percent = modData.total > 0 ? Math.round((modData.correct / modData.total) * 100) : 0;
                    const avgTime = modData.total > 0 ? (item.duration || 0) / modData.total : 0;
                    
                    moduleDetails.push({
                        date: item.date,
                        module: filters.module,
                        correct: modData.correct,
                        wrong: modData.wrong,
                        unanswered: modData.unanswered,
                        total: modData.total,
                        avgTime: avgTime,
                        percent: percent
                    });
                }
            });
            
            if (moduleDetails.length === 0) {
                document.getElementById('no-module-detail').classList.remove('hidden');
                document.getElementById('no-module-detail').innerHTML = `
                    <i class="fas fa-info-circle mb-2 block text-2xl"></i>
                    <p>Nenhum simulado encontrado para o módulo "${filters.module}" no período selecionado.</p>
                `;
            } else {
                moduleDetails.forEach(x => {
                    moduleDetailBody.innerHTML += `
                        <tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <td class="px-6 py-4">${new Date(x.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4 text-xs text-slate-500" title="${x.module}">
                                ${x.module.length > 30 ? x.module.substring(0, 30) + '...' : x.module}
                            </td>
                            <td class="px-6 py-4 text-green-600 font-bold">${x.correct}</td>
                            <td class="px-6 py-4 text-red-600 font-bold">${x.wrong}</td>
                            <td class="px-6 py-4 text-slate-500 font-bold">${x.unanswered}</td>
                            <td class="px-6 py-4 text-slate-700 dark:text-slate-300 font-bold">${x.total}</td>
                            <td class="px-6 py-4 text-slate-600 font-mono">${x.avgTime.toFixed(1)}s</td>
                            <td class="px-6 py-4 text-right font-bold ${x.percent >= 70 ? 'text-green-600' : x.percent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${x.percent}%</td>
                        </tr>
                    `;
                });
            }
        }

        // Atualizar gráficos 2D
        renderHistoryChart(h);
        renderDistributionChart(h);
        renderTrendChart(h);
        renderPieChart(h);
        updateMetricsCards();
    }
    
    function renderHistoryChart(historyData) {
        const ctx = document.getElementById('historyChart').getContext('2d');
        
        if (historyChartInstance) {
            historyChartInstance.destroy();
        }
        
        if (historyData.length === 0) {
            historyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Desempenho (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Desempenho: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) { return value + '%'; }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
            return;
        }
        
        const labels = historyData.map(item => 
            new Date(item.date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})
        ).reverse();
        
        const percentages = historyData.map(item => item.percent).reverse();
        
        historyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Desempenho (%)',
                    data: percentages,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `Desempenho: ${context.parsed.y}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.1)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    function renderDistributionChart(historyData) {
        const ctx = document.getElementById('distributionChart').getContext('2d');
        
        if (distributionChartInstance) {
            distributionChartInstance.destroy();
        }
        
        if (historyData.length === 0) {
            distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Acertos', 'Erros', 'Brancos'],
                    datasets: [{
                        label: 'Questões',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(148, 163, 184, 0.7)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)',
                            'rgb(148, 163, 184)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });
            return;
        }
        
        const totalCorrect = historyData.reduce((sum, item) => sum + item.correct, 0);
        const totalWrong = historyData.reduce((sum, item) => sum + item.wrong, 0);
        const totalUnanswered = historyData.reduce((sum, item) => sum + item.unanswered, 0);
        
        distributionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Acertos', 'Erros', 'Brancos'],
                datasets: [{
                    label: 'Questões',
                    data: [totalCorrect, totalWrong, totalUnanswered],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(148, 163, 184, 0.7)'
                    ],
                    borderColor: [
                        'rgb(34, 197, 94)',
                        'rgb(239, 68, 68)',
                        'rgb(148, 163, 184)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }
    
    function renderTrendChart(historyData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }
        
        if (historyData.length < 2) {
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Desempenho (%)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'Tendência',
                            data: [],
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(value) { return value + '%'; } }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
            return;
        }
        
        const labels = historyData.map(item => 
            new Date(item.date).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})
        ).reverse();
        
        const percentages = historyData.map(item => item.percent).reverse();
        
        const n = percentages.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        for (let i = 0; i < n; i++) {
            sumX += i;
            sumY += percentages[i];
            sumXY += i * percentages[i];
            sumX2 += i * i;
        }
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        const trendData = [];
        for (let i = 0; i < n; i++) {
            trendData.push(slope * i + intercept);
        }
        
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Desempenho (%)',
                        data: percentages,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    },
                    {
                        label: 'Tendência',
                        data: trendData,
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: function(value) { return value + '%'; } }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function exportHistoryCSV() {
        let h = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
        
        if (h.length === 0) {
            alert("Nenhum histórico para exportar.");
            return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Data,Módulo,Acertos,Erros,Branco,Nota(%),Duração(s),Detalhes\n";
        
        h.forEach(item => {
            const date = new Date(item.date).toLocaleString();
            const modules = Object.keys(item.modules || {});
            
            if (modules.length === 0) {
                csvContent += `"${date}","Sem módulo",${item.correct},${item.wrong},${item.unanswered},${item.percent},${item.duration || 0},""\n`;
            } else if (modules.length === 1) {
                const mod = modules[0];
                const modData = item.modules[mod];
                const percent = modData.total > 0 ? Math.round((modData.correct / modData.total) * 100) : 0;
                csvContent += `"${date}","${mod}",${modData.correct},${modData.wrong},${modData.unanswered},${percent},${item.duration || 0},""\n`;
            } else {
                csvContent += `"${date}","Vários módulos",${item.correct},${item.wrong},${item.unanswered},${item.percent},${item.duration || 0},"${modules.join('; ')}"\n`;
            }
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `historico_simulados_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function importHistoryCSV() {
        document.getElementById('csv-import-modal').classList.remove('hidden');
    }
    
    function closeCSVImportModal() {
        document.getElementById('csv-import-modal').classList.add('hidden');
        document.getElementById('csv-file-input').value = '';
    }
    
    function processCSVImport() {
        const fileInput = document.getElementById('csv-file-input');
        if (!fileInput.files.length) {
            alert("Selecione um arquivo CSV para importar.");
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const lines = content.split('\n');
                
                if (lines.length < 2) {
                    alert("Arquivo CSV vazio ou inválido.");
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                
                const expectedHeaders = ['Data', 'Módulo', 'Acertos', 'Erros', 'Branco', 'Nota(%)', 'Duração(s)', 'Detalhes'];
                const hasRequiredHeaders = expectedHeaders.every(h => headers.includes(h));
                
                if (!hasRequiredHeaders) {
                    alert("Formato de CSV inválido. Verifique os cabeçalhos.");
                    return;
                }
                
                const newHistory = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    
                    if (values.length < 6) continue;
                    
                    const date = new Date(values[0]);
                    if (isNaN(date.getTime())) {
                        console.warn(`Data inválida na linha ${i+1}: ${values[0]}`);
                        continue;
                    }
                    
                    const moduleName = values[1];
                    const correct = parseInt(values[2]) || 0;
                    const wrong = parseInt(values[3]) || 0;
                    const unanswered = parseInt(values[4]) || 0;
                    const percent = parseInt(values[5]) || 0;
                    const duration = parseInt(values[6]) || 0;
                    
                    let modules = {};
                    
                    if (moduleName === 'Vários módulos' || moduleName === 'Sem módulo') {
                        modules = {};
                    } else {
                        modules[moduleName] = {
                            correct: correct,
                            wrong: wrong,
                            unanswered: unanswered,
                            total: correct + wrong + unanswered
                        };
                    }
                    
                    newHistory.push({
                        date: date,
                        correct: correct,
                        wrong: wrong,
                        unanswered: unanswered,
                        total: correct + wrong + unanswered,
                        percent: percent,
                        duration: duration,
                        modules: modules
                    });
                }
                
                if (newHistory.length === 0) {
                    alert("Nenhum dado válido encontrado no arquivo.");
                    return;
                }
                
                let existingHistory = JSON.parse(localStorage.getItem('alerr_hist') || '[]');
                existingHistory = [...newHistory, ...existingHistory];
                
                if (existingHistory.length > 100) {
                    existingHistory = existingHistory.slice(0, 100);
                }
                
                localStorage.setItem('alerr_hist', JSON.stringify(existingHistory));
                
                closeCSVImportModal();
                loadHistory(historyFilters);
                update3dCharts();
                updateCacheStats();
                
                alert(`${newHistory.length} registros importados com sucesso!`);
            } catch (error) {
                console.error("Erro ao processar CSV:", error);
                alert("Erro ao processar o arquivo CSV. Verifique o formato.");
            }
        };
        
        reader.readAsText(file);
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        loadDatabase();
        
        // Inicializa gráficos 3D com Plotly.js
        init3dCharts();
        
        setTimeout(() => {
            loadHistory();
        }, 500);

        const savedPref = localStorage.getItem('alerr_save_pref');
        appState.savingEnabled = savedPref !== 'false';
        document.getElementById('toggle-save-history').checked = appState.savingEnabled;
        updateCacheStats();
        
        updateThemeIcon();
        
        updateFilterButtons();
        update3dFilterButtons();
    });
  </script>
</body>
</html>
